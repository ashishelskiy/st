{% extends "service_track_app/base.html" %}
{% block title %}–ü–∞–∫–µ—Ç {{ p.id }}{% endblock %}

{% block content %}
<div id="receivedSection" class="section active">
<div class="received-requests-section">
    <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="window.location.href='{% url 'received_requests' %}'">üì¶ –ü–æ—Å—Ç—É–ø–∏–≤—à–∏–µ –≤ –°–¶</span>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">–ü–∞–∫–µ—Ç –æ—Ç {{ p.created_at|date:"d.m.Y" }}</span>
    </div>
    {% if p.status == 'sent' %}
    <form method="post" action="{% url 'accept_selected_requests' p.id %}">
        {% csrf_token %}
        <div id="packageDetailsContainer" class="package-details active">
<!--            <button class="back-btn" onclick="window.location.href='{% url 'received_requests' %}'">‚Üê –ö –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–º –≤ –°–¶</button>-->
            <button type="button" class="back-btn" onclick="history.back()">‚Üê –ö –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–º –≤ –°–¶</button>
            <div class="requests-title" id="packageDetailsTitle">–û—Ç–ø—Ä–∞–≤–∫–∞ {{ p.dealer_company }} –æ—Ç {{ p.created_at|date:"d.m.Y" }}</div>

            <div id="packageRequestsContainer">
                <div class="package-requests-mini-table">
                    <table class="mini-requests-table">
                        <thead>
                            <tr>
                                <th class="checkbox-header">–ü–æ—Å—Ç—É–ø–∏–ª–∏</th>
                                <th>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–æ–≤–∞—Ä–∞</th>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
                                <th>–ü—Ä–æ–±–ª–µ–º–∞</th>
                                <th>–§–æ—Ç–æ/–í–∏–¥–µ–æ</th>
                                <th>–ù–∞ —Ä–µ–º–æ–Ω—Ç</th>
                                <th>–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in requests %}
                            <tr class="package-request-row {% if r.received_by_sc %}received-row{% endif %}"
                                data-request-id="{{ r.id }}"
                                onclick="openRequestDetail({{ r.id }})" style="cursor: pointer;">
                                <td class="checkbox-cell">
                                    <input type="checkbox" class="received-checkbox"
                                           name="selected_requests"
                                           value="{{ r.id }}"
                                           id="request-{{ r.id }}"
                                           data-request-id="{{ r.id }}"
                                           {% if r.received_by_sc %}checked disabled{% endif %}
                                           onclick="event.stopPropagation()">
                                </td>
                                <td>{{ r.serial_number }}</td>
                                <td>{{ r.product }}</td>
                                <td>{{ r.customer_name }}</td>
                                <td title="{{ r.problem_description }}">
                                    {{ r.problem_description|truncatechars:30 }}
                                </td>
                                <td class="attachments-mini">
                                    {% if r.photos.exists or r.videos.exists %}
                                        {% if r.photos.exists %}<span title="{{ r.photos.count }} —Ñ–æ—Ç–æ">üñº</span>{% endif %}
                                        {% if r.videos.exists %}<span title="{{ r.videos.count }} –≤–∏–¥–µ–æ">üé¨</span>{% endif %}
                                    {% else %}
                                        <span class="no-attachments">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if r.warranty_status == "warranty" %}
                                        <span class="request-status status-sent">–ù–∞ –≥–∞—Ä–∞–Ω—Ç–∏–∏</span>
                                    {% elif r.warranty_status == "paid_repair" %}
                                        <span class="request-status status-created">–ü–ª–∞—Ç–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</span>
                                    {% elif r.warranty_status == "diagnostics" %}
                                        <span class="request-status status-created">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</span>
                                    {% else %}
                                        <span class="request-status status-created">{{ r.get_warranty_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ r.created_at|date:"d.m.Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <button type="submit" class="accept-btn">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
    </form>
    {% elif p.status == 'accepted' %}
    <form method="post" action="">
        {% csrf_token %}
        <div id="packageDetailsContainer" class="package-details active">
<!--            <button class="back-btn" onclick="window.location.href='{% url 'received_requests' %}'">‚Üê –ö –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–º –≤ –°–¶</button>-->
            <button type="button" class="back-btn" onclick="history.back()">‚Üê –ö –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–º –≤ –°–¶</button>
            <div class="requests-title" id="packageDetailsTitle">–û—Ç–ø—Ä–∞–≤–∫–∞ {{ p.dealer_company }} –æ—Ç {{ p.created_at|date:"d.m.Y" }}</div>

            <div id="packageRequestsContainer">
                <div class="package-requests-mini-table">
                    <table class="mini-requests-table">
                        <thead>
                            <tr>
                                <th class="checkbox-header">–ü–æ—Å—Ç—É–ø–∏–ª–∏</th>
                                <th>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–æ–≤–∞—Ä–∞</th>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
                                <th>–ü—Ä–æ–±–ª–µ–º–∞</th>
                                <th>–§–æ—Ç–æ/–í–∏–¥–µ–æ</th>
                                <th>–ù–∞ —Ä–µ–º–æ–Ω—Ç</th>
                                <th>–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in requests %}
                            <tr class="package-request-row {% if r.received_by_sc %}received-row{% endif %}"
                                data-request-id="{{ r.id }}"
                                onclick="openRequestDetail({{ r.id }})" style="cursor: pointer;">
                                <td class="checkbox-cell">
                                    <input type="checkbox" class="received-checkbox"
                                           name="selected_requests"
                                           value="{{ r.id }}"
                                           id="request-{{ r.id }}"
                                           data-request-id="{{ r.id }}"
                                           {% if r.received_by_sc %}checked disabled{% endif %}
                                           onclick="event.stopPropagation()">
                                </td>
                                <td>{{ r.serial_number }}</td>
                                <td>{{ r.product }}</td>
                                <td>{{ r.customer_name }}</td>
                                <td title="{{ r.problem_description }}">
                                    {{ r.problem_description|truncatechars:30 }}
                                </td>
                                <td class="attachments-mini">
                                    {% if r.photos.exists or r.videos.exists %}
                                        {% if r.photos.exists %}<span title="{{ r.photos.count }} —Ñ–æ—Ç–æ">üñº</span>{% endif %}
                                        {% if r.videos.exists %}<span title="{{ r.videos.count }} –≤–∏–¥–µ–æ">üé¨</span>{% endif %}
                                    {% else %}
                                        <span class="no-attachments">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if r.warranty_status == "warranty" %}
                                        <span class="request-status status-sent">–ù–∞ –≥–∞—Ä–∞–Ω—Ç–∏–∏</span>
                                    {% elif r.warranty_status == "paid_repair" %}
                                        <span class="request-status status-created">–ü–ª–∞—Ç–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</span>
                                    {% elif r.warranty_status == "diagnostics" %}
                                        <span class="request-status status-created">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</span>
                                    {% else %}
                                        <span class="request-status status-created">{{ r.get_warranty_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ r.created_at|date:"d.m.Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <button type="submit" class="accept-btn">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å</button>
    </form>
    {% endif %}
</div>
</div>

<style>
.requests-title {
    /*font-size: 1.2rem;*/
    font-size: 1.0rem;
    font-weight: 600;
    color: #333;
    /*flex: 1;*/
}
.package-requests-mini-table {
    margin: 10px 0;
    max-height: none; /* –£–±–∏—Ä–∞–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
}

.mini-requests-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.8em; /* –ß—É—Ç—å –±–æ–ª—å—à–µ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏ */
}

.mini-requests-table th {
    background-color: #f5f5f5;
    padding: 6px 8px;
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid #e0e0e0;
    position: sticky;
    top: 0;
}

.mini-requests-table td {
    padding: 4px 6px;
    border-bottom: 1px solid #f0f0f0;
}

.mini-requests-table tr:last-child td {
    border-bottom: none;
}

.request-status {
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.8em;
    white-space: nowrap;
}

.status-sent {
    background-color: #e3f2fd;
    color: #1976d2;
}

.status-created {
    background-color: #fff3e0;
    color: #f57c00;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —á–µ–∫–±–æ–∫—Å–æ–≤ –∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è */
.checkbox-header {
    text-align: center;
    width: 60px;
}

.checkbox-cell {
    text-align: center;
    vertical-align: middle;
}

.received-checkbox {
    transform: scale(1.1);
    cursor: pointer;
}

.received-row {
    background-color: #f8fff9 !important;
}

.attachments-mini {
    text-align: center;
}

.attachments-mini span {
    cursor: help;
    opacity: 0.8;
}

.no-attachments {
    color: #999;
    font-style: italic;
}

.package-request-row {
    cursor: pointer;
    transition: background-color 0.2s;
}

.package-request-row:hover {
    background-color: #f8f9fa;
}
</style>
<script>
    function openRequestDetail(requestId) {
        window.location.href = `{% url 'request_detail' 0 %}`.replace('0', requestId);
    }

</script>
{% endblock %}