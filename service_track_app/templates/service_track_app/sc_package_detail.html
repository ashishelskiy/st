{% extends "service_track_app/base.html" %}
{% block title %}–ü–∞–∫–µ—Ç {{ p.id }}{% endblock %}

{% block content %}
{# ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è –æ—Ç Django messages #}
{% if messages %}
    <div>
        {% for message in messages %}
            <div class="notification">
                {{ message }}
            </div>
        {% endfor %}
    </div>
{% endif %}

<div class="received-requests-section">
    <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="window.location.href='{% url 'received_requests' %}'">üì¶ –ü–æ—Å—Ç—É–ø–∏–≤—à–∏–µ –≤ –°–¶</span>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">–ü–∞–∫–µ—Ç –æ—Ç {{ p.created_at|date:"d.m.Y" }}</span>
    </div>

    {% if p.status == 'sent' %}
    <form method="post" action="{% url 'accept_selected_requests' p.id %}" id="packageForm">
        {% csrf_token %}
        <div id="packageDetailsContainer" class="package-details active">
            <button type="button" class="back-btn" onclick="history.back()">‚Üê –ö –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–º –≤ –°–¶</button>
            <div class="requests-title" id="packageDetailsTitle">–û—Ç–ø—Ä–∞–≤–∫–∞ {{ p.dealer_company }} –æ—Ç {{ p.created_at|date:"d.m.Y" }}</div>

            <div id="packageRequestsContainer">
                <div class="package-requests-mini-table">
                    <table class="mini-requests-table">
                        <thead>
                            <tr>
                                <th class="checkbox-header">–ü–æ—Å—Ç—É–ø–∏–ª–∏</th>
                                <th>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–æ–≤–∞—Ä–∞</th>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
                                <th>–ü—Ä–æ–±–ª–µ–º–∞</th>
                                <th>–§–æ—Ç–æ/–í–∏–¥–µ–æ</th>
                                <th>–ù–∞ —Ä–µ–º–æ–Ω—Ç</th>
                                <th>–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞</th>
                                <th class="action-header">–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in requests %}
                            <tr class="package-request-row {% if r.received_by_sc %}received-row{% endif %}"
                                data-request-id="{{ r.id }}">
                                <td class="checkbox-cell">
                                    <input type="checkbox" class="received-checkbox"
                                           name="selected_requests"
                                           value="{{ r.id }}"
                                           id="request-{{ r.id }}"
                                           data-request-id="{{ r.id }}"
                                           {% if r.received_by_sc %}checked disabled{% endif %}>
                                </td>

                                <!-- –°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä - —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –ø–æ –∫–ª–∏–∫—É -->
                                <td class="editable-field" data-field="serial_number">
                                    <span class="field-value">{{ r.serial_number }}</span>
                                    <input type="text" class="field-input" value="{{ r.serial_number }}" style="display: none;">
                                </td>

                                <!-- –¢–æ–≤–∞—Ä - —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –ø–æ –∫–ª–∏–∫—É -->
<!--                                <td class="editable-field" data-field="product">-->
<!--                                    <span class="field-value">{{ r.product }}</span>-->
<!--                                    <input type="text" class="field-input" value="{{ r.product }}" style="display: none;">-->
<!--                                </td>-->
                                <!-- –¢–æ–≤–∞—Ä - –ù–ï —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π -->
                                <td class="product-cell">
                                    <span>{{ r.product }}</span>
                                </td>

                                <!-- –ü–æ–∫—É–ø–∞—Ç–µ–ª—å - —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –ø–æ –∫–ª–∏–∫—É -->
                                <td class="editable-field" data-field="customer_name">
                                    <span class="field-value">{{ r.customer_name }}</span>
                                    <input type="text" class="field-input" value="{{ r.customer_name }}" style="display: none;">
                                </td>

                                <!-- –ü—Ä–æ–±–ª–µ–º–∞ - —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è –ø–æ –∫–ª–∏–∫—É -->
                                <td class="editable-field" data-field="problem_description">
                                    <span class="field-value" title="{{ r.problem_description }}">
                                        {{ r.problem_description|truncatechars:30 }}
                                    </span>
                                    <textarea class="field-input" style="display: none;">{{ r.problem_description }}</textarea>
                                </td>

                                <td class="attachments-mini attachments-cell">
                                    {% if r.photos.exists or r.videos.exists %}
                                        {% if r.photos.exists %}<span title="{{ r.photos.count }} —Ñ–æ—Ç–æ">üñº</span>{% endif %}
                                        {% if r.videos.exists %}<span title="{{ r.videos.count }} –≤–∏–¥–µ–æ">üé¨</span>{% endif %}
                                    {% else %}
                                        <span class="no-attachments">‚Äî</span>
                                    {% endif %}
                                </td>

                                <!-- –°—Ç–∞—Ç—É—Å –≥–∞—Ä–∞–Ω—Ç–∏–∏ - —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–π –ø–æ –∫–ª–∏–∫—É -->
                                <td class="editable-field" data-field="warranty_status">
                                    <span class="field-value">
                                        {% if r.warranty_status == "warranty" %}
                                            <span class="request-status status-sent">–ù–∞ –≥–∞—Ä–∞–Ω—Ç–∏–∏</span>
                                        {% elif r.warranty_status == "paid_repair" %}
                                            <span class="request-status status-created">–ü–ª–∞—Ç–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</span>
                                        {% elif r.warranty_status == "diagnostics" %}
                                            <span class="request-status status-created">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</span>
                                        {% else %}
                                            <span class="request-status status-created">{{ r.get_warranty_status_display }}</span>
                                        {% endif %}
                                    </span>
                                    <select class="field-input" style="display: none;">
                                        <option value="warranty" {% if r.warranty_status == "warranty" %}selected{% endif %}>–ù–∞ –≥–∞—Ä–∞–Ω—Ç–∏–∏</option>
                                        <option value="paid_repair" {% if r.warranty_status == "paid_repair" %}selected{% endif %}>–ü–ª–∞—Ç–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</option>
                                        <option value="diagnostics" {% if r.warranty_status == "diagnostics" %}selected{% endif %}>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</option>
                                    </select>
                                </td>

                                <td class="created-date-cell">{{ r.created_at|date:"d.m.Y" }}</td>

                                <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
                                <td class="action-cell">
                                    <a href="{% url 'request_detail' r.id %}" class="detail-btn" title="–û—Ç–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É">
                                        üëÅÔ∏è
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <button type="submit" class="accept-btn">‚úÖ –ü—Ä–∏–Ω—è—Ç—å</button>
    </form>

    {% elif p.status == 'accepted' %}
    <form method="post" action="">
        {% csrf_token %}
        <div id="packageDetailsContainer" class="package-details active">
<!--            <button class="back-btn" onclick="window.location.href='{% url 'received_requests' %}'">‚Üê –ö –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–º –≤ –°–¶</button>-->
            <button type="button" class="back-btn" onclick="history.back()">‚Üê –ö –ø–æ—Å—Ç—É–ø–∏–≤—à–∏–º –≤ –°–¶</button>
            <div class="requests-title" id="packageDetailsTitle">–û—Ç–ø—Ä–∞–≤–∫–∞ {{ p.dealer_company }} –æ—Ç {{ p.created_at|date:"d.m.Y" }}</div>

            <div id="packageRequestsContainer">
                <div class="package-requests-mini-table">
                    <table class="mini-requests-table">
                        <thead>
                            <tr>
                                <th class="checkbox-header">–ü–æ—Å—Ç—É–ø–∏–ª–∏</th>
                                <th>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–æ–≤–∞—Ä–∞</th>
                                <th>–¢–æ–≤–∞—Ä</th>
                                <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
                                <th>–ü—Ä–æ–±–ª–µ–º–∞</th>
                                <th>–§–æ—Ç–æ/–í–∏–¥–µ–æ</th>
                                <th>–ù–∞ —Ä–µ–º–æ–Ω—Ç</th>
                                <th>–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in requests %}
                            <tr class="package-request-row {% if r.received_by_sc %}received-row{% endif %}"
                                data-request-id="{{ r.id }}"
                                onclick="openRequestDetail({{ r.id }})" style="cursor: pointer;">
                                <td class="checkbox-cell">
                                    <input type="checkbox" class="received-checkbox"
                                           name="selected_requests"
                                           value="{{ r.id }}"
                                           id="request-{{ r.id }}"
                                           data-request-id="{{ r.id }}"
                                           {% if r.received_by_sc %}checked disabled{% endif %}
                                           onclick="event.stopPropagation()">
                                </td>
                                <td>{{ r.serial_number }}</td>
                                <td>{{ r.product }}</td>
                                <td>{{ r.customer_name }}</td>
                                <td title="{{ r.problem_description }}">
                                    {{ r.problem_description|truncatechars:30 }}
                                </td>
                                <td class="attachments-mini">
                                    {% if r.photos.exists or r.videos.exists %}
                                        {% if r.photos.exists %}<span title="{{ r.photos.count }} —Ñ–æ—Ç–æ">üñº</span>{% endif %}
                                        {% if r.videos.exists %}<span title="{{ r.videos.count }} –≤–∏–¥–µ–æ">üé¨</span>{% endif %}
                                    {% else %}
                                        <span class="no-attachments">‚Äî</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if r.warranty_status == "warranty" %}
                                        <span class="request-status status-sent">–ù–∞ –≥–∞—Ä–∞–Ω—Ç–∏–∏</span>
                                    {% elif r.warranty_status == "paid_repair" %}
                                        <span class="request-status status-created">–ü–ª–∞—Ç–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</span>
                                    {% elif r.warranty_status == "diagnostics" %}
                                        <span class="request-status status-created">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</span>
                                    {% else %}
                                        <span class="request-status status-created">{{ r.get_warranty_status_display }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ r.created_at|date:"d.m.Y" }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <button type="submit" class="accept-btn">‚Ü©Ô∏è –í–µ—Ä–Ω—É—Ç—å</button>
    </form>
    {% endif %}
</div>

<style>
/* –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è */

/* –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª—å –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ "–ü—Ä–∏–Ω—è—Ç–æ" */
.status-accepted {
    background-color: #4CAF50;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}

/* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –í–µ—Ä–Ω—É—Ç—å */
.return-btn {
    background-color: #ff9800;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 1em;
    margin-top: 15px;
    transition: background-color 0.3s;
}

.return-btn:hover {
    background-color: #f57c00;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã—Ö –ø–æ–ª–µ–π */
.editable-field {
    cursor: pointer;
    position: relative;
    transition: background-color 0.2s;
}

.editable-field:hover {
    background-color: #f0f8ff !important;
}

.field-input {
    width: 100%;
    border: 2px solid #007bff;
    border-radius: 4px;
    padding: 4px 6px;
    font-size: 0.8em;
    box-sizing: border-box;
    background: white;
    font-family: inherit;
}

.field-input:focus {
    outline: none;
    border-color: #0056b3;
    box-shadow: 0 0 0 3px rgba(0,123,255,.1);
}

/* –î–ª—è textarea –≤ –ø–æ–ª–µ –ø—Ä–æ–±–ª–µ–º—ã */
.field-input.textarea {
    min-height: 50px;
    resize: vertical;
}

/* –î–ª—è select */
.field-input.select {
    cursor: pointer;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ */
.action-header {
    width: 80px;
    text-align: center;
}

.action-cell {
    text-align: center;
    padding: 4px 2px !important;
}

.detail-btn {
    display: inline-block;
    background: none;
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 0.9em;
    transition: all 0.2s;
    text-decoration: none;
    color: inherit;
}

.detail-btn:hover {
    background-color: #f8f9fa;
    border-color: #007bff;
    transform: scale(1.05);
    text-decoration: none;
    color: inherit;
}

/* –ü–æ–¥—Å–∫–∞–∑–∫–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–µ –ø–æ–ª—è */
.editable-field:hover::after {
    content: "–î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è";
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #333;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.7em;
    white-space: nowrap;
    z-index: 1000;
    pointer-events: none;
}
</style>

<script>
// JavaScript –∫–æ–¥ –¢–û–õ–¨–ö–û –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ 'sent' (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
function openRequestDetail(requestId) {
    window.location.href = `{% url 'request_detail' 0 %}`.replace('0', requestId);
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–≥–æ –ø–æ–ª—è
let currentlyEditingCell = null;

// –û–°–ù–û–í–ù–û–ô –û–ë–†–ê–ë–û–¢–ß–ò–ö –î–í–û–ô–ù–û–ì–û –ö–õ–ò–ö–ê (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ 'sent')
document.addEventListener('DOMContentLoaded', function() {
    // –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ 'sent')
    document.querySelectorAll('.editable-field').forEach(cell => {
        cell.addEventListener('dblclick', function(e) {
            e.stopPropagation();
            startEditing(this);
        });
    });

    // –û–±—ã—á–Ω—ã–π –∫–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∑–∞—è–≤–∫—É (–¥–ª—è –æ–±–æ–∏—Ö —Å—Ç–∞—Ç—É—Å–æ–≤)
    document.querySelectorAll('.package-request-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–µ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–º –ø–æ–ª–µ, –Ω–µ –Ω–∞ —á–µ–∫–±–æ–∫—Å–µ, –Ω–µ –Ω–∞ field-input –∏ –Ω–µ –Ω–∞ –∫–Ω–æ–ø–∫–µ
            if (!e.target.closest('.editable-field') &&
                !e.target.closest('.received-checkbox') &&
                !e.target.closest('.field-input') &&
                !e.target.closest('.detail-btn') &&
                !e.target.closest('.product-cell') &&
                !e.target.closest('.attachments-cell') &&
                !e.target.closest('.created-date-cell')) {
                const requestId = this.dataset.requestId;
                openRequestDetail(requestId);
            }
        });
    });

    // –ß–µ–∫–±–æ–∫—Å—ã –Ω–µ –¥–æ–ª–∂–Ω—ã –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –∑–∞—è–≤–∫—É
    document.querySelectorAll('.received-checkbox').forEach(checkbox => {
        checkbox.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Å—Å—ã–ª–∫–∏ –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã
    document.querySelectorAll('.detail-btn').forEach(link => {
        link.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });

    // –ó–∞–∫—Ä—ã–≤–∞—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ 'sent')
    document.addEventListener('click', function(e) {
        if (currentlyEditingCell &&
            !currentlyEditingCell.contains(e.target) &&
            !e.target.closest('.editable-field')) {
            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –¥–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å—Å—è –¥—Ä—É–≥–∏–º –∫–ª–∏–∫–∞–º
            setTimeout(() => {
                if (currentlyEditingCell) {
                    finishEditing(currentlyEditingCell, false); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
                }
            }, 10);
        }
    });

    // –¢–∞–∫–∂–µ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ Escape (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ 'sent')
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && currentlyEditingCell) {
            finishEditing(currentlyEditingCell, true); // true = –æ—Ç–º–µ–Ω–∞
        }
    });

    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ Enter –≤ –ø–æ–ª—è—Ö –≤–≤–æ–¥–∞
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.target.closest('.field-input')) {
            e.stopPropagation();
        }
    });
});

// –§–£–ù–ö–¶–ò–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ 'sent')
function startEditing(cell) {
    // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ
    if (currentlyEditingCell && currentlyEditingCell !== cell) {
        finishEditing(currentlyEditingCell, false); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–ª—è
    }

    const valueElement = cell.querySelector('.field-value');
    const inputElement = cell.querySelector('.field-input');

    valueElement.style.display = 'none';
    inputElement.style.display = 'block';

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ –æ—Ç–∫–∞—Ç–∞
    cell._originalValue = inputElement.value;

    if (inputElement.tagName === 'INPUT' || inputElement.tagName === 'TEXTAREA') {
        inputElement.select();
    } else if (inputElement.tagName === 'SELECT') {
        inputElement.focus();
    }

    currentlyEditingCell = cell;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    if (inputElement.tagName === 'SELECT') {
        inputElement.addEventListener('change', function() {
            finishEditing(cell, false);
        });
    } else {
        inputElement.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                finishEditing(cell, false);
            }
        });
    }
}

// –§–£–ù–ö–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ò–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø (—Ç–æ–ª—å–∫–æ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ 'sent')
async function finishEditing(cell, cancel = false) {
    if (!cell) return;

    const valueElement = cell.querySelector('.field-value');
    const inputElement = cell.querySelector('.field-input');
    const fieldName = cell.dataset.field;
    const requestId = cell.closest('tr').dataset.requestId;

    let newValue;
    if (cancel) {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ
        newValue = cell._originalValue;
        if (inputElement.tagName === 'SELECT') {
            inputElement.value = newValue;
        } else {
            inputElement.value = newValue;
        }
    } else {
        newValue = inputElement.value;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    updateDisplayValue(cell, newValue);

    // –ü—Ä—è—á–µ–º input, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º value
    inputElement.style.display = 'none';
    valueElement.style.display = 'inline';

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–µ –æ—Ç–º–µ–Ω–∞ –∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å
    if (!cancel && newValue !== cell._originalValue) {
        await trySaveToServer(requestId, fieldName, newValue);
    }

    // –£–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    if (inputElement.tagName === 'SELECT') {
        inputElement.replaceWith(inputElement.cloneNode(true));
    }

    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ–µ –ø–æ–ª–µ
    if (currentlyEditingCell === cell) {
        currentlyEditingCell = null;
    }
}

// –û–ë–ù–û–í–õ–ï–ù–ò–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø
function updateDisplayValue(cell, newValue) {
    const valueElement = cell.querySelector('.field-value');
    const fieldName = cell.dataset.field;

    if (fieldName === 'warranty_status') {
        const inputElement = cell.querySelector('.field-input');
        const selectedOption = inputElement.options[inputElement.selectedIndex];
        const statusText = selectedOption ? selectedOption.text : '–ù–µ –≤—ã–±—Ä–∞–Ω–æ';
        const statusClass = inputElement.value === 'warranty' ? 'status-sent' : 'status-created';
        valueElement.innerHTML = `<span class="request-status ${statusClass}">${statusText}</span>`;
    } else if (fieldName === 'problem_description') {
        valueElement.textContent = newValue.length > 30 ? newValue.substring(0, 30) + '...' : newValue;
        valueElement.setAttribute('title', newValue);
    } else {
        valueElement.textContent = newValue;
    }
}

// –°–û–•–†–ê–ù–ï–ù–ò–ï –ù–ê –°–ï–†–í–ï–†
async function trySaveToServer(requestId, fieldName, value) {
    const csrfToken = getCSRFToken();
    const formData = new FormData();
    formData.append(fieldName, value);
    formData.append('csrfmiddlewaretoken', csrfToken);

    try {
        const response = await fetch(`/api/request/${requestId}/update/`, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });

        const result = await response.json();

        if (result.success) {
            showNotification('‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            return true;
        } else {
            showNotification('‚ùå –û—à–∏–±–∫–∞: ' + result.error, 'error');
            return false;
        }
    } catch (error) {
        showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏', 'error');
        return false;
    }
}

// –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø
function showNotification(message, type) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const existingNotification = document.querySelector('.custom-notification');
    if (existingNotification) {
        document.body.removeChild(existingNotification);
    }

    const notification = document.createElement('div');
    notification.textContent = message;
    notification.className = 'custom-notification';
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 4px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        transition: opacity 0.3s;
        ${type === 'success' ? 'background: #4CAF50;' : 'background: #f44336;'}
    `;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            if (notification.parentNode) {
                document.body.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// CSRF –¢–û–ö–ï–ù
function getCSRFToken() {
    let token = document.querySelector('[name=csrfmiddlewaretoken]');
    if (token && token.value) return token.value;

    token = document.querySelector('meta[name="csrf-token"]');
    if (token && token.getAttribute('content')) return token.getAttribute('content');

    const cookieMatch = document.cookie.match(/csrftoken=([^;]+)/);
    if (cookieMatch) return cookieMatch[1];

    return '';
}
</script>
{% endblock %}