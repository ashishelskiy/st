{% extends "service_track_app/base.html" %}
{% block title %}–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É{% endblock %}

{% block content %}
<div class="form-section">
    <div class="form-title">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</div>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
<!--        {{ form.media }}-->
<!--        <style>-->
<!--        .select2-container&#45;&#45;default .select2-selection&#45;&#45;single {-->
<!--            height: 38px;-->
<!--            padding: 5px 10px;-->
<!--        }-->
<!--        table { width: 100%; border-collapse: collapse; }-->
<!--        th, td { padding: 5px; border: 1px solid #ccc; }-->
<!--        .btn { cursor: pointer; margin: 2px; padding: 4px 8px; border: 1px solid #ccc; border-radius: 4px; }-->
<!--        </style>-->
        {% for field in form %}
            <div class="form-group">
                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }} {% if field.field.required %}*{% endif %}</label>
                {{ field }}
            </div>
        {% endfor %}

        <!-- –ë–ª–æ–∫ –¥–ª—è —Ñ–æ—Ç–æ -->
        <div class="form-group">
            <label class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞</label>
            <div class="file-upload-container" id="photoUploadContainer" onclick="document.getElementById('photoUpload').click()">
                <div class="file-upload-icon">üì∑</div>
                <div class="file-upload-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</div>
                <div style="font-size: 0.85rem; color: #999;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF (–º–∞–∫—Å. 5 –ú–ë –∫–∞–∂–¥—ã–π)</div>
            </div>
            <input type="file" id="photoUpload" name="photos" class="file-upload-input" multiple accept="image/*">
            <div id="filePreview" class="file-preview"></div>
            <button type="button" class="clear-btn" onclick="clearAllPhotos()" style="margin-top: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ñ–æ—Ç–æ</button>
        </div>

        <!-- –ë–ª–æ–∫ –¥–ª—è –≤–∏–¥–µ–æ -->
        <div class="form-group">
            <label class="form-label">–í–∏–¥–µ–æ —Ç–æ–≤–∞—Ä–∞</label>
            <div class="file-upload-container" id="videoUploadContainer" onclick="document.getElementById('videoUpload').click()">
                <div class="file-upload-icon">üé•</div>
                <div class="file-upload-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤–∏–¥–µ–æ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</div>
                <div style="font-size: 0.85rem; color: #999;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: MP4, AVI, MOV, WMV (–º–∞–∫—Å. 50 –ú–ë –∫–∞–∂–¥—ã–π)</div>
            </div>
            <input type="file" id="videoUpload" name="videos" class="file-upload-input" multiple accept="video/*">
            <div id="videoPreview" class="file-preview"></div>
            <button type="button" class="clear-btn" onclick="clearAllVideos()" style="margin-top: 10px; padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer;">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –≤–∏–¥–µ–æ</button>
        </div>

        <button type="submit" class="submit-btn">üìù –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
    </form>
</div>
<!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Select2 -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    $('.select2-product').select2({
        placeholder: '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä...',
        allowClear: true,
        width: '100%'
    });
});
</script>
<script>
    let uploadedFiles = [];
    let uploadedVideos = [];

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø
    function handleFileUpload() {
        const fileInput = document.getElementById('photoUpload');
        const files = Array.from(fileInput.files);

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
        files.forEach(file => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ñ–∞–π–ª
            const isDuplicate = uploadedFiles.some(existingFile =>
                existingFile.name === file.name && existingFile.size === file.size
            );

            if (isDuplicate) {
                showNotification(`–§–∞–π–ª ${file.name} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω`, 'warning');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                showNotification(`–§–∞–π–ª ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5 –ú–ë)`, 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedFiles.push({
                    name: file.name,
                    size: file.size,
                    url: e.target.result,
                    fileObject: file
                });
                updateFilePreview();
            };
            reader.readAsDataURL(file);
        });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
    function updateFilePreview() {
        const preview = document.getElementById('filePreview');
        if (uploadedFiles.length === 0) {
            preview.classList.remove('show');
            preview.innerHTML = '';
            return;
        }

        preview.classList.add('show');
        let previewHTML = '';
        uploadedFiles.forEach((file, index) => {
            const fileSize = (file.size / 1024).toFixed(1) + ' –ö–ë';
            previewHTML += `
                <div class="file-preview-item">
                    <img src="${file.url}" alt="${file.name}" class="file-preview-image">
                    <div class="file-preview-info">
                        <div class="file-preview-name">${file.name}</div>
                        <div class="file-preview-size">${fileSize}</div>
                    </div>
                    <button type="button" class="file-remove-btn" onclick="removeUploadedFile(${index})">√ó</button>
                </div>
            `;
        });
        preview.innerHTML = previewHTML;
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    function removeUploadedFile(index) {
        uploadedFiles.splice(index, 1);
        updateFileInput('photoUpload', uploadedFiles);
        updateFilePreview();
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö —Ñ–æ—Ç–æ
    function clearAllPhotos() {
        uploadedFiles = [];
        document.getElementById('photoUpload').value = '';
        updateFilePreview();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø
    function handleVideoUpload() {
        const videoInput = document.getElementById('videoUpload');
        const files = Array.from(videoInput.files);

        // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º
        files.forEach(file => {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Ñ–∞–π–ª
            const isDuplicate = uploadedVideos.some(existingFile =>
                existingFile.name === file.name && existingFile.size === file.size
            );

            if (isDuplicate) {
                showNotification(`–í–∏–¥–µ–æ ${file.name} —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ`, 'warning');
                return;
            }

            if (file.size > 50 * 1024 * 1024) {
                showNotification(`–í–∏–¥–µ–æ ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–µ (–º–∞–∫—Å. 50 –ú–ë)`, 'error');
                return;
            }

            const url = URL.createObjectURL(file);
            uploadedVideos.push({
                name: file.name,
                size: file.size,
                url: url,
                fileObject: file
            });
        });

        updateVideoPreview();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –¥–ª—è –≤–∏–¥–µ–æ
    function updateVideoPreview() {
        const preview = document.getElementById('videoPreview');
        if (uploadedVideos.length === 0) {
            preview.classList.remove('show');
            preview.innerHTML = '';
            return;
        }

        preview.classList.add('show');
        let previewHTML = '';
        uploadedVideos.forEach((file, index) => {
            const fileSize = (file.size / 1024 / 1024).toFixed(1) + ' –ú–ë';
            previewHTML += `
                <div class="file-preview-item">
                    <video src="${file.url}" controls class="file-preview-video" style="width: 100%; max-width: 300px; height: auto;"></video>
                    <div class="file-preview-info">
                        <div class="file-preview-name">${file.name}</div>
                        <div class="file-preview-size">${fileSize}</div>
                    </div>
                    <button type="button" class="file-remove-btn" onclick="removeUploadedVideo(${index})">√ó</button>
                </div>
            `;
        });
        preview.innerHTML = previewHTML;
    }

    // –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ
    function removeUploadedVideo(index) {
        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º URL –æ–±—ä–µ–∫—Ç–∞
        if (uploadedVideos[index].url) {
            URL.revokeObjectURL(uploadedVideos[index].url);
        }
        uploadedVideos.splice(index, 1);
        updateFileInput('videoUpload', uploadedVideos);
        updateVideoPreview();
    }

    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –≤–∏–¥–µ–æ
    function clearAllVideos() {
        // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –≤—Å–µ URL –æ–±—ä–µ–∫—Ç–æ–≤
        uploadedVideos.forEach(video => {
            if (video.url) {
                URL.revokeObjectURL(video.url);
            }
        });
        uploadedVideos = [];
        document.getElementById('videoUpload').value = '';
        updateVideoPreview();
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ input —Ñ–∞–π–ª–æ–≤ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
    function updateFileInput(inputId, filesArray) {
        const input = document.getElementById(inputId);
        const dt = new DataTransfer();

        filesArray.forEach(file => {
            if (file.fileObject) {
                dt.items.add(file.fileObject);
            }
        });

        input.files = dt.files;
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    function showNotification(message, type = 'success') {
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
        let notification = document.getElementById('notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 10px;
                color: white;
                z-index: 1000;
                transition: all 0.3s ease;
            `;
            document.body.appendChild(notification);
        }

        notification.textContent = message;
        notification.style.background = type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : '#28a745';
        notification.style.display = 'block';

        setTimeout(() => {
            notification.style.display = 'none';
        }, 4000);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –∫–Ω–æ–ø–æ–∫
    document.getElementById('photoUpload').addEventListener('change', handleFileUpload);
    document.getElementById('videoUpload').addEventListener('change', handleVideoUpload);

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ drag-and-drop
    const photoUploadContainer = document.getElementById('photoUploadContainer');
    const videoUploadContainer = document.getElementById('videoUploadContainer');

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ drag-and-drop –¥–ª—è —Ñ–æ—Ç–æ
    ['dragover', 'dragenter'].forEach(event => {
        photoUploadContainer.addEventListener(event, (e) => {
            e.preventDefault();
            photoUploadContainer.classList.add('dragover');
        });
    });

    ['dragleave', 'dragend', 'drop'].forEach(event => {
        photoUploadContainer.addEventListener(event, (e) => {
            e.preventDefault();
            photoUploadContainer.classList.remove('dragover');
        });
    });

    photoUploadContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));

        if (files.length === 0) {
            showNotification('–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–æ–ª—å–∫–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è', 'warning');
            return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –≤ input
        const currentFiles = Array.from(document.getElementById('photoUpload').files);
        const allFiles = [...currentFiles, ...files];

        const dt = new DataTransfer();
        allFiles.forEach(file => dt.items.add(file));
        document.getElementById('photoUpload').files = dt.files;

        handleFileUpload();
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ drag-and-drop –¥–ª—è –≤–∏–¥–µ–æ
    ['dragover', 'dragenter'].forEach(event => {
        videoUploadContainer.addEventListener(event, (e) => {
            e.preventDefault();
            videoUploadContainer.classList.add('dragover');
        });
    });

    ['dragleave', 'dragend', 'drop'].forEach(event => {
        videoUploadContainer.addEventListener(event, (e) => {
            e.preventDefault();
            videoUploadContainer.classList.remove('dragover');
        });
    });

    videoUploadContainer.addEventListener('drop', (e) => {
        e.preventDefault();
        const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('video/'));

        if (files.length === 0) {
            showNotification('–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ç–æ–ª—å–∫–æ –≤–∏–¥–µ–æ —Ñ–∞–π–ª—ã', 'warning');
            return;
        }

        // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –≤ input
        const currentFiles = Array.from(document.getElementById('videoUpload').files);
        const allFiles = [...currentFiles, ...files];

        const dt = new DataTransfer();
        allFiles.forEach(file => dt.items.add(file));
        document.getElementById('videoUpload').files = dt.files;

        handleVideoUpload();
    });

    // –û—á–∏—Å—Ç–∫–∞ URL –æ–±—ä–µ–∫—Ç–æ–≤ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', () => {
        uploadedVideos.forEach(video => {
            if (video.url) {
                URL.revokeObjectURL(video.url);
            }
        });
    });
</script>
<style>
    .file-preview-video {
        width: 100%;
        max-width: 300px;
        height: auto;
        border-radius: 4px;
    }

    .clear-btn {
        margin-top: 10px;
        padding: 8px 16px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: all 0.3s ease;
    }

    .clear-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
    }
</style>
{% endblock %}