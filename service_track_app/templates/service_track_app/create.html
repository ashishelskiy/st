{% extends "service_track_app/base.html" %}
{% block title %}–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É{% endblock %}

{% block content %}
<div class="form-section">
    <div class="form-title">–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç</div>
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
<!--        {{ form.as_p }}-->
        {% for field in form %}
            <div class="form-group">
                <label class="form-label" for="{{ field.id_for_label }}">{{ field.label }} {% if field.field.required %}*{% endif %}</label>
                {{ field }}
            </div>
        {% endfor %}
        <div class="form-group">
            <label class="form-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ —Ç–æ–≤–∞—Ä–∞</label>
            <div class="file-upload-container" onclick="document.getElementById('photoUpload').click()">
                <div class="file-upload-icon">üì∑</div>
                <div class="file-upload-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–π –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</div>
                <div style="font-size: 0.85rem; color: #999;">–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç—ã: JPG, PNG, GIF (–º–∞–∫—Å. 5 –ú–ë –∫–∞–∂–¥—ã–π)</div>
            </div>
            <input type="file" id="photoUpload" name="photos" class="file-upload-input" multiple accept="image/*">
            <div id="filePreview" class="file-preview"></div>
        </div>
        <button type="submit" class="submit-btn">üìù –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É</button>
    </form>
</div>
<script>
    let uploadedFiles = [];

    function handleFileUpload() {
        const fileInput = document.getElementById('photoUpload');
        const files = Array.from(fileInput.files);

        // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π preview –ø—Ä–∏ –Ω–æ–≤–æ–º –≤—ã–±–æ—Ä–µ
        uploadedFiles = [];

        files.forEach(file => {
            if (file.size > 5 * 1024 * 1024) { // 5MB
                showNotification(`–§–∞–π–ª ${file.name} —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5 –ú–ë)`, 'error');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedFiles.push({
                    name: file.name,
                    size: file.size,
                    url: e.target.result,
                    fileObject: file // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª
                });
                updateFilePreview();
            };
            reader.readAsDataURL(file);
        });

        //fileInput.value = '';
    }

    function updateFilePreview() {
        const preview = document.getElementById('filePreview');

        if (uploadedFiles.length === 0) {
            preview.classList.remove('show');
            return;
        }

        preview.classList.add('show');

        let previewHTML = '';
        uploadedFiles.forEach((file, index) => {
            const fileSize = (file.size / 1024).toFixed(1) + ' –ö–ë';
            previewHTML += `
                <div class="file-preview-item">
                    <img src="${file.url}" alt="${file.name}" class="file-preview-image">
                    <div class="file-preview-info">
                        <div class="file-preview-name">${file.name}</div>
                        <div class="file-preview-size">${fileSize}</div>
                    </div>
                    <button type="button" class="file-remove-btn" onclick="removeUploadedFile(${index})">√ó</button>
                </div>
            `;
        });

        preview.innerHTML = previewHTML;
    }

    //function removeUploadedFile(index) {
    //    uploadedFiles.splice(index, 1);
    //    updateFilePreview();
    //}

    function removeUploadedFile(index) {
        uploadedFiles.splice(index, 1);

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å fileInput
        const fileInput = document.getElementById('photoUpload');
        const dt = new DataTransfer();

        uploadedFiles.forEach(file => {
            if (file.fileObject) {
                dt.items.add(file.fileObject);
            }
        });

        fileInput.files = dt.files;
        updateFilePreview();
    }

    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.className = `notification ${type} show`;

        setTimeout(() => {
            notification.classList.remove('show');
        }, 4000);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('photoUpload').addEventListener('change', handleFileUpload);

    // Drag & Drop –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
    const uploadContainer = document.querySelector('.file-upload-container');

    uploadContainer.addEventListener('dragover', function(e) {
        e.preventDefault();
        this.classList.add('dragover');
    });

    uploadContainer.addEventListener('dragleave', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');
    });

    uploadContainer.addEventListener('drop', function(e) {
        e.preventDefault();
        this.classList.remove('dragover');

        const files = Array.from(e.dataTransfer.files);
        const fileInput = document.getElementById('photoUpload');

        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π FileList
        const dt = new DataTransfer();
        files.forEach(file => dt.items.add(file));
        fileInput.files = dt.files;

        handleFileUpload();
    });
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    //document.getElementById('customerPhone').addEventListener('input', function(e) {
    document.getElementById('id_customer_phone').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 0) {
            if (value.length <= 1) {
                value = '+7 (' + value;
            } else if (value.length <= 4) {
                value = '+7 (' + value.substring(1);
            } else if (value.length <= 7) {
                value = '+7 (' + value.substring(1, 4) + ') ' + value.substring(4);
            } else if (value.length <= 9) {
                value = '+7 (' + value.substring(1, 4) + ') ' + value.substring(4, 7) + '-' + value.substring(7);
            } else {
                value = '+7 (' + value.substring(1, 4) + ') ' + value.substring(4, 7) + '-' + value.substring(7, 9) + '-' + value.substring(9, 11);
            }
        }
        e.target.value = value;
    });
</script>
{% endblock %}
