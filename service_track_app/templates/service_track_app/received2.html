{% extends "service_track_app/base.html" %}
{% block title %}–ü–æ—Å—Ç—É–ø–∏–≤—à–∏–µ –∑–∞—è–≤–∫–∏{% endblock %}

{% block content %}
<div class="received-section">

    <!-- –§–∏–ª—å—Ç—Ä—ã –∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ -->
    <div class="filter-controls">
        <button type="button" onclick="toggleReceivedView('packages')">üì¶ –ü–∞–∫–µ—Ç—ã</button>
        <button type="button" onclick="toggleReceivedView('requests')">üìÑ –ó–∞—è–≤–∫–∏</button>

        <!-- –ù–æ–≤—ã–π –±–ª–æ–∫ —Ñ–∏–ª—å—Ç—Ä–æ–≤ -->
        <div class="advanced-filters" style="margin-top: 10px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <div class="filter-row">
                <span>–û—Ç–±–æ—Ä:</span>
                <select id="filterField" onchange="updateFilterOptions()">
                    <option value="status">–°—Ç–∞—Ç—É—Å</option>
                    <option value="dealer">–î–∏–ª–µ—Ä</option>
                    <option value="model">–ú–æ–¥–µ–ª—å</option>
                    <option value="serial">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</option>
                    <option value="date">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</option>
                </select>
                <select id="filterOperator">
                    <option value="equals">—Ä–∞–≤–Ω–æ</option>
                    <option value="contains">—Å–æ–¥–µ—Ä–∂–∏—Ç</option>
                    <option value="startswith">–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å</option>
                </select>
                <input type="text" id="filterValue" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ">
                <button type="button" onclick="applyAdvancedFilter()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                <button type="button" onclick="clearAdvancedFilter()">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>
        </div>
    </div>

    <!-- –ë–ª–æ–∫ —Å –ø–∞–∫–µ—Ç–∞–º–∏ -->
    <div id="receivedPackages" style="display:block;">
        {% for p in packages %}
        <div class="package-card" onclick="window.location.href='{% url 'package_detail' p.id %}'">
            <div class="package-header">
                <div class="package-date">üì¶ {{ p.dealer_company }} –æ—Ç {{ p.created_at|date:"d.m.Y" }}</div>
                <div class="package-count">{{ p.request_count }} –∑–∞—è–≤–æ–∫</div>
            </div>
            <div class="package-info">
                <div class="package-info-item">
                    <span>üïí</span>
                    <span>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ {{ p.created_at|date:"H:i" }}</span>
                </div>
            </div>
        </div>
        {% empty %}
            <p>–ù–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤</p>
        {% endfor %}
    </div>

    <!-- –ë–ª–æ–∫ —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –∑–∞—è–≤–∫–∞–º–∏ -->
    <div id="receivedRequests" style="display:none;">
        <table class="requests-table">
            <thead>
                <tr>
                    <th>‚Ññ –∑–∞—è–≤–∫–∏</th>
                    <th>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
                    <th>–ú–æ–¥–µ–ª—å</th>
                    <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
                    <th>–ü—Ä–æ–±–ª–µ–º–∞</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                </tr>
            </thead>
            <tbody id="requestsTableBody">
                {% for r in repair_requests %}
                <tr class="request-row" onclick="window.location.href='{% url 'request_detail' r.id %}'">
                    <td>#{{ r.id }}</td>
                    <td>{{ r.serial_number }}</td>
                    <td>{{ r.model_name }}</td>
                    <td>{{ r.customer_name }}</td>
                    <td>{{ r.problem_description|truncatechars:50 }}</td>
                    <td>{{ r.get_status_display }}</td>
                    <td>{{ r.created_at|date:"d.m.Y H:i" }}</td>
                </tr>
                {% empty %}
                    <tr><td colspan="7">–ù–µ—Ç –∑–∞—è–≤–æ–∫</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

</div>

<script>
function toggleReceivedView(view) {
    document.getElementById('receivedPackages').style.display = (view === 'packages') ? 'block' : 'none';
    document.getElementById('receivedRequests').style.display = (view === 'requests') ? 'block' : 'none';
}

function updateFilterOptions() {
    const field = document.getElementById('filterField').value;
    const operatorSelect = document.getElementById('filterOperator');

    // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ–ø—Ü–∏–∏
    operatorSelect.innerHTML = '';

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—è
    if (field === 'date') {
        operatorSelect.innerHTML = `
            <option value="equals">—Ä–∞–≤–Ω–æ</option>
            <option value="after">–ø–æ—Å–ª–µ</option>
            <option value="before">–¥–æ</option>
            <option value="between">–º–µ–∂–¥—É</option>
        `;
    } else {
        operatorSelect.innerHTML = `
            <option value="equals">—Ä–∞–≤–Ω–æ</option>
            <option value="contains">—Å–æ–¥–µ—Ä–∂–∏—Ç</option>
            <option value="startswith">–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å</option>
            <option value="endswith">–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞</option>
        `;
    }
}

function applyAdvancedFilter() {
    const field = document.getElementById('filterField').value;
    const operator = document.getElementById('filterOperator').value;
    const value = document.getElementById('filterValue').value.toLowerCase();

    let rows = document.querySelectorAll('#receivedRequests tbody tr');

    rows.forEach(row => {
        let cellValue = '';
        let display = false;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∏–∑ –∫–∞–∫–æ–π –∫–æ–ª–æ–Ω–∫–∏ –±—Ä–∞—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        switch(field) {
            case 'status':
                cellValue = row.cells[5].textContent.toLowerCase();
                break;
            case 'dealer':
                // –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –¥–∏–ª–µ—Ä –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–µ–∫—Å—Ç–µ –ø–∞–∫–µ—Ç–∞
                cellValue = row.closest('.package-card') ?
                    row.closest('.package-card').querySelector('.package-date').textContent.toLowerCase() :
                    '';
                break;
            case 'model':
                cellValue = row.cells[2].textContent.toLowerCase();
                break;
            case 'serial':
                cellValue = row.cells[1].textContent.toLowerCase();
                break;
            case 'date':
                cellValue = row.cells[6].textContent.toLowerCase();
                break;
        }

        // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        switch(operator) {
            case 'equals':
                display = cellValue === value;
                break;
            case 'contains':
                display = cellValue.includes(value);
                break;
            case 'startswith':
                display = cellValue.startsWith(value);
                break;
            case 'endswith':
                display = cellValue.endsWith(value);
                break;
            case 'after':
                // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –¥–∞—Ç (–º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞)
                display = new Date(cellValue) > new Date(value);
                break;
            case 'before':
                display = new Date(cellValue) < new Date(value);
                break;
        }

        row.style.display = display ? '' : 'none';
    });
}

function clearAdvancedFilter() {
    document.getElementById('filterValue').value = '';
    let rows = document.querySelectorAll('#receivedRequests tbody tr');
    rows.forEach(row => {
        row.style.display = '';
    });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', function() {
    updateFilterOptions();
});
</script>

<style>
.filter-row {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
}

.filter-row select, .filter-row input {
    padding: 5px;
    border: 1px solid #ccc;
    border-radius: 3px;
}

.filter-row button {
    padding: 5px 10px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 3px;
    cursor: pointer;
}

.filter-row button:hover {
    background-color: #0056b3;
}
</style>

{% endblock %}