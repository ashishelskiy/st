{% extends "service_track_app/base.html" %}
{% block title %}–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ #{{ repair_request.id }} (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ){% endblock %}

{% block content %}
<div class="request-detail-section">
    <div class="breadcrumb">
        {% for crumb in breadcrumbs %}
            <span class="{% if forloop.last %}breadcrumb-current{% else %}breadcrumb-item{% endif %}"
                  {% if not forloop.last %}onclick="window.location.href='{{ crumb.url }}'" style="cursor: pointer;"{% endif %}>
                {% if forloop.first %}üì¶{% endif %} {{ crumb.title }}
            </span>
            {% if not forloop.last %}
                <span class="breadcrumb-separator">‚Ä∫</span>
            {% endif %}
        {% endfor %}
    </div>
    <form method="POST" action="{% url 'request_detail' repair_request.id %}">
        {% csrf_token %}

        <div class="request-details-actions">
            <button class="action-btn btn-secondary" type="button"
                onclick="window.location.href='{{ back_url }}'">
                ‚Üê –ö {{ back_title }}
            </button>
<!--            <button class="action-btn btn-primary" type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>-->
        </div>

        <div class="request-detail-header">
            <div class="request-detail-title">–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ #{{ repair_request.id }} (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)</div>
        </div>
        <div class="request-details-form">
            <input type="hidden" name="request_id" value="{{ repair_request.id }}">
            <div class="details-row">
                <div class="details-group">
                    <label for="id_serial_number" class="details-label">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–æ–≤–∞—Ä–∞</label>
                    {{ form.serial_number }}
                </div>
                <div class="details-group">
                    <label for="id_model_name" class="details-label">–¢–æ–≤–∞—Ä</label>
                    {{ form.product }}
                </div>
            </div>
            <div class="details-row">
                <div class="details-group">
                    <label for="id_purchase_date" class="details-label">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</label>
                    {{ form.purchase_date }}
                </div>
                <div class="details-group">
                    <label for="id_warranty_status" class="details-label">–°—Ç–∞—Ç—É—Å –≥–∞—Ä–∞–Ω—Ç–∏–∏</label>
                    {{ form.warranty_status }}
                </div>
            </div>
            <div class="details-row">
                <div class="details-group" style="grid-column: 1 / 2;">
                    <label for="id_problem_description" class="details-label">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏</label>
                    {{ form.problem_description }}
                </div>
                <div class="details-group" style="grid-column: 2 / 3;">
                    <label for="id_problem_description" class="details-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</label>
                    {{ form.additional_notes }}
                </div>
            </div>
            <div class="details-row">
                <div class="details-group" style="grid-column: 1 / -1;">
                    <label for="id_status" class="details-label">–°—Ç–∞—Ç—É—Å</label>
                    {{ form.status }}
                </div>
            </div>
            <div class="details-row">
                <div class="details-group" style="grid-column: 1 / 2;">
                    <div class="details-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</div>
                    <div class="photo-gallery" id="detailsPhotoGallery">
                        {% if photos %}
                            {% for p in photos %}
                                <div class="photo-item" style="position: relative; display: inline-block; margin: 5px; width: 150px; height: 150px; overflow: hidden; border-radius: 10px;">
                                    <img src="{{ p.photo.url }}" alt="{{ p.photo.name }}"
                                         style="display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 10px; cursor: pointer;"
                                         onclick="viewPhoto('{{ p.photo.url }}')">
                                    <button class="photo-overlay"
                                            onclick="removePhoto({{ p.id }})"
                                            title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ"
                                            style="position:absolute; top:5px; right:5px; background:#0008; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer;">
                                        √ó
                                    </button>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div style="color: #666; font-style: italic; padding: 20px; text-align: center;">
                                –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="details-group" style="grid-column: 2 / 3;">
                    <div class="details-label">–í–∏–¥–µ–æ</div>
                    <div class="video-gallery" id="detailsVideoGallery">
                        {% if videos %}
                            {% for v in videos %}
                                <div class="video-item" style="position: relative; display: inline-block; margin: 5px; width: 320px; height: 240px; overflow: hidden; border-radius: 10px;">
                                    <video controls style="display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
                                        <source src="{{ v.video.url }}" type="video/mp4">
                                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                                    </video>
                                    <button class="video-overlay"
                                            onclick="removeVideo({{ v.id }})"
                                            title="–£–¥–∞–ª–∏—Ç—å –≤–∏–¥–µ–æ"
                                            style="position:absolute; top:5px; right:5px; background:#0008; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer;">
                                        √ó
                                    </button>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div style="color: #666; font-style: italic; padding: 20px; text-align: center;">
                                –í–∏–¥–µ–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- –ë–ª–æ–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
            <div class="details-group" style="grid-column: 1 / -1; background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="margin: 0 0 20px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>

                <div class="details-row">
                    <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                        <label for="id_diagnosis_date" class="details-label">–î–∞—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</label>
                        {{ form.diagnosis_date }}
                    </div>
                    <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                        <label for="id_completion_date" class="details-label">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</label>
                        {{ form.completion_date }}
                    </div>
                </div>

                <div class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
                    <label for="id_service_employee" class="details-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–µ—Ä–≤–∏—Å–∞</label>
                    {{ form.service_employee }}
                </div>

                <div class="details-row">
                    <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                        <label for="id_conclusion" class="details-label">–ó–∞–∫–ª—é—á–µ–Ω–∏–µ</label>
                        {{ form.conclusion }}
                    </div>
                    <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                        <label for="id_decision" class="details-label">–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ</label>
                        {{ form.decision }}
                    </div>
                </div>

                <div id="paid_repair_fields" style="display: none;">
                    <div class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
                        <label for="id_malfunction_formulation" class="details-label">–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏</label>
                        {{ form.malfunction_formulation }}
                    </div>
                    <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                        <label for="id_price_type" class="details-label">–¢–∏–ø —Ü–µ–Ω</label>
                        {{ form.price_type }}
                    </div>
                </div>

<!--                <div class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">-->
<!--                    <label for="id_act_status" class="details-label">–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∞</label>-->
<!--                    {{ form.act_status }}-->
<!--                </div>-->

<!--                {% if repair_request.conclusion and repair_request.decision %}-->
<!--                    <button type="button"-->
<!--                            onclick="window.open('{% url 'generate_act_docx' repair_request.id %}', '_blank')"-->
<!--                            title="–°–∫–∞—á–∞—Ç—å –∞–∫—Ç (Word)"-->
<!--                            style="margin-top: 20px; padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px;">-->
<!--                        <span style="font-size: 18px;">üìÑ</span>-->
<!--                        <span>–°–∫–∞—á–∞—Ç—å –∞–∫—Ç (Word)</span>-->
<!--                    </button>-->
<!--                {% else %}-->
<!--                    <div style="margin-top: 20px; padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">-->
<!--                        ‚ö†Ô∏è –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ" –∏ "–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ" –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"-->
<!--                    </div>-->
<!--                {% endif %}-->
            </div>

            <!-- –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç -->
            <div id="warranty_repair_section" class="details-group" style="grid-column: 1 / -1; background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none;">
                <h3 style="margin: 0 0 20px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</h3>

                <div id="refusal_reason_group" class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1; display: none;">
                    <label for="id_refusal_reason" class="details-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ –æ—Ç —Ä–µ–º–æ–Ω—Ç–∞</label>
                    {{ form.refusal_reason }}
                </div>

                <div id="detected_problem_group" class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
                    <label for="id_detected_problem" class="details-label">–í—ã—è–≤–ª–µ–Ω–Ω–∞—è –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å</label>
                    {{ form.detected_problem }}
                </div>

                <div id="repair_details_group" class="details-row">
                    <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                        <label for="id_repair_date" class="details-label">–î–∞—Ç–∞ —Ä–µ–º–æ–Ω—Ç–∞</label>
                        {{ form.repair_date }}
                    </div>
                    <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                        <label for="id_repair_type" class="details-label">–í–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞</label>
                        {{ form.repair_type }}
                    </div>

                    <div id="acoustics_repair_subtype" style="display: none;">
                        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                            <label for="id_acoustics_repair_subtype" class="details-label">–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞ –∞–∫—É—Å—Ç–∏–∫–∏</label>
                            {{ form.acoustics_repair_subtype }}
                            <datalist id="acoustics_options">
                                <option value="–ó–∞–º–µ–Ω–∞ –í–ß –¥–∏–Ω–∞–º–∏–∫–∞">
                                <option value="–ó–∞–º–µ–Ω–∞ –¥–∏–Ω–∞–º–∏–∫–∞">
                                <option value="–ó–∞–º–µ–Ω–∞ –¥–∏–Ω–∞–º–∏–∫–æ–≤">
                                <option value="–ó–∞–º–µ–Ω–∞ –∑–≤—É–∫–æ–≤–æ–π –∫–∞—Ç—É—à–∫–∏">
                                <option value="–ó–∞–º–µ–Ω–∞ –∫–æ—Ä–∑–∏–Ω—ã">
                                <option value="–ó–∞–º–µ–Ω–∞ –∫–æ—Ä–∑–∏–Ω—ã –∏ –ø–æ–¥–≤–∏–∂–Ω–æ–π —á–∞—Å—Ç–∏ –¥–∏–Ω–∞–º–∏–∫–∞">
                                <option value="–ó–∞–º–µ–Ω–∞ –ø–æ–¥–≤–∏–∂–Ω–æ–π —á–∞—Å—Ç–∏ –¥–∏–Ω–∞–º–∏–∫–∞">
                                <option value="–ó–∞–º–µ–Ω–∞ –ø–æ–¥–≤–∏–∂–Ω—ã—Ö —á–∞—Å—Ç–µ–π –¥–∏–Ω–∞–º–∏–∫–æ–≤">
                                <option value="–ó–∞–º–µ–Ω–∞ –ø—ã–ª–µ–∑–∞—â–∏—Ç–Ω–æ–≥–æ –∫–æ–ª–ø–∞–∫–∞">
                                <option value="–ó–∞–º–µ–Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞">
                                <option value="–ü—Ä–æ–∫–ª–µ–∏–≤–∞–Ω–∏–µ">
                                <option value="–ü—Ä–æ–∫–ª–µ–∏–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É—é—â–∏—Ö —à–∞–π–±">
                                <option value="–ü—Ä–æ–∫–ª–µ–∏–≤–∞–Ω–∏–µ –ø–æ–¥–≤–µ—Å–∞">
                                <option value="–ü—Ä–æ–∫–ª–µ–∏–≤–∞–Ω–∏–µ –ø—ã–ª–µ–∑–∞—â–∏—Ç–Ω–æ–≥–æ –∫–æ–ª–ø–∞–∫–∞">
                                <option value="–ü—Ä–æ–ø–∞–π–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤">
                                <option value="–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ –±–µ–∑ –∑–∞–º–µ–Ω—ã –ø–æ–¥–≤–∏–∂–Ω–æ–π —á–∞—Å—Ç–∏">
                                <option value="–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä—ã–≤–∞ –∑–≤—É–∫–æ–≤–æ–π –∫–∞—Ç—É—à–∫–∏">
                                <option value="–¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ –ø–æ–¥–≤–∏–∂–Ω–æ–π —á–∞—Å—Ç–∏">
                                <option value="–ß–∏—Å—Ç–∫–∞ –∑–∞–∑–æ—Ä–∞ –º–∞–≥–Ω–∏—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–∏–Ω–∞–º–∏–∫–∞">
                            </datalist>
                        </div>
                    </div>

                    <div id="amplifier_repair_subtype" style="display: none;">
                        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                            <label for="id_amplifier_repair_subtype" class="details-label">–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞ —É—Å–∏–ª–∏—Ç–µ–ª—è</label>
                            {{ form.amplifier_repair_subtype }}
                            <datalist id="amplifier_options">
                                <option value="–ó–∞–º–µ–Ω–∞ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞">
                                <option value="–ó–∞–º–µ–Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π">
                                <option value="–ó–∞–º–µ–Ω–∞ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏">
                                <option value="–ó–∞–º–µ–Ω–∞ —Ç–æ–ª–∫–∞—Ç–µ–ª—è –∫–Ω–æ–ø–∫–∏">
                                <option value="–ó–∞–º–µ–Ω–∞ —Ç—é–ª—å–ø–∞–Ω–æ–≤ –ì–°–ê">
                                <option value="–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–π —Ä–µ–º–æ–Ω—Ç">
                                <option value="–ü–∏—Ç–∞–Ω–∏–µ –û–£">
                                <option value="–ü—Ä–æ–ø–∞–π–∫–∞ –ì–°–ê">
                                <option value="–†–µ–º–æ–Ω—Ç –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∫–∞—Å–∫–∞–¥–∞">
                                <option value="–†–µ–º–æ–Ω—Ç –ë–ü">
                                <option value="–†–µ–º–æ–Ω—Ç –ë–ü –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∫–∞—Å–∫–∞–¥–∞">
                                <option value="–†–µ–º–æ–Ω—Ç –û–£">
                                <option value="–†–µ–º–æ–Ω—Ç –ü–£">
                                <option value="–§–∏–ª—å—Ç—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∫–∞—Å–∫–∞–¥–∞">
                                <option value="–§–∏–ª—å—Ç—Ä –ø–∏—Ç–∞–Ω–∏—è –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞">
                            </datalist>
                        </div>
                    </div>
                </div>

                <div id="repair_performed_group" class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
                    <label for="id_repair_performed" class="details-label">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</label>
                    {{ form.repair_performed }}
                </div>

                <div id="additional_info_group" class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
                    <label for="id_additional_info" class="details-label">–î–æ–ø –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
                    {{ form.additional_info }}
                </div>

                <div id="internal_comment_group" class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
                    <label for="id_internal_comment" class="details-label">–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    {{ form.internal_comment }}
                </div>

                <div id="payment_section" style="display: none;">
                    <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É -->
                    <div class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
                        <label for="id_payment_link" class="details-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É</label>
                        {{ form.payment_link }}
                    </div>

                    <!-- –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ -->
                    <div class="details-row">
                        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                            <label for="id_labor_cost" class="details-label">–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç</label>
                            {{ form.labor_cost }}
                        </div>
                        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                            <label for="id_parts_cost" class="details-label">–ó–∞–ø—á–∞—Å—Ç–∏</label>
                            {{ form.parts_cost }}
                        </div>
                        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                            <label for="id_total_cost" class="details-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                            {{ form.total_cost }}
                        </div>
                        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                            <label for="id_parts_discount" class="details-label">% —Å–∫–∏–¥–∫–∏ –Ω–∞ –∑–∞–ø—á–∞—Å—Ç–∏</label>
                            {{ form.parts_discount }}
                        </div>
                        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                            <label for="id_paid_by_client" class="details-label">–û–ø–ª–∞—á–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–º</label>
                            {{ form.paid_by_client }}
                        </div>
                        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                            <label for="id_payment_date" class="details-label">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</label>
                            {{ form.payment_date }}
                        </div>
                    </div>
                </div>
            </div>
            <div class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
                <label for="id_act_status" class="details-label">–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∞</label>
                {{ form.act_status }}
            </div>
            {% if repair_request.conclusion and repair_request.decision %}
                <button type="button"
                        onclick="window.open('{% url 'generate_act_docx' repair_request.id %}', '_blank')"
                        title="–°–∫–∞—á–∞—Ç—å –∞–∫—Ç (Word)"
                        style="margin-top: 20px; padding: 8px 16px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 18px;">üìÑ</span>
                    <span>–°–∫–∞—á–∞—Ç—å –∞–∫—Ç (Word)</span>
                </button>
            {% else %}
                <div style="margin-top: 20px; padding: 12px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; color: #856404;">
                    ‚ö†Ô∏è –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∞–∫—Ç–∞ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ "–ó–∞–∫–ª—é—á–µ–Ω–∏–µ" –∏ "–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ" –∏ –Ω–∞–∂–º–∏—Ç–µ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
                </div>
            {% endif %}
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                <small style="color: #666; font-size: 12px;">
                    ‚ìò –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </small>
                <button class="action-btn btn-primary" type="submit"
                        style="padding: 10px 25px; font-size: 14px; display: flex; align-items: center; gap: 8px;">
                    <span>üíæ</span>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </button>
            </div>
        </div>
    </form>
    <div id="confirmationModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <div class="modal-content" style="background-color: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); max-width: 400px; width: 90%;">
            <div style="text-align: center; margin-bottom: 25px;">
                <div style="font-size: 24px; margin-bottom: 10px;">‚ö†Ô∏è</div>
                <h3 style="margin: 0 0 10px 0; color: #333;">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</h3>
                <p style="color: #666; margin: 0; font-size: 14px;">
                    –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∑–∞—è–≤–∫–µ #{{ repair_request.id }}?
                </p>
            </div>

            <div style="display: flex; gap: 15px; justify-content: center;">
                <button type="button" id="confirmSaveBtn"
                        style="padding: 10px 25px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; flex: 1;">
                    –î–∞, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button type="button" id="cancelSaveBtn"
                        style="padding: 10px 25px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: 500; flex: 1;">
                    –ù–µ—Ç, –æ—Ç–º–µ–Ω–∞
                </button>
            </div>

            <div style="margin-top: 15px; text-align: center;">
                <small style="color: #888; font-size: 12px;">
                    ‚ìò –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
                </small>
            </div>
        </div>
    </div>
</div>
<!-- ... –≤–∞—à HTML –∫–æ–¥ ... -->

</form>
    <div id="confirmationModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
        <!-- ... –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ ... -->
    </div>
</div>

<script>
// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========

let originalForm = null;
let isSubmitting = false;
let isFormChanged = false;
let initialFormData = null;

// ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê ==========

function showConfirmationModal() {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    if (!isFormChanged) {
        alert('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
        return;
    }

    const modal = document.getElementById('confirmationModal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

function hideConfirmationModal() {
    const modal = document.getElementById('confirmationModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

function confirmSave() {
    if (isSubmitting) return;

    isSubmitting = true;
    const submitBtn = document.querySelector('button[type="submit"]');

    if (submitBtn) {
        submitBtn.innerHTML = '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        submitBtn.disabled = true;

        setTimeout(() => {
            originalForm.submit();
        }, 500);
    }
}

function cancelSave() {
    hideConfirmationModal();
    isSubmitting = false;
}

// ========== –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–ï –ò–ó–ú–ï–ù–ï–ù–ò–ô –í –§–û–†–ú–ï ==========

function getFormData() {
    const form = document.querySelector('form[method="POST"]');
    if (!form) return null;

    const formData = new FormData(form);
    const data = {};

    for (let [key, value] of formData.entries()) {
        if (data[key]) {
            if (Array.isArray(data[key])) {
                data[key].push(value);
            } else {
                data[key] = [data[key], value];
            }
        } else {
            data[key] = value;
        }
    }

    return JSON.stringify(data);
}

function checkFormChanges() {
    const currentData = getFormData();

    if (!initialFormData) {
        initialFormData = currentData;
        return false;
    }

    isFormChanged = (currentData !== initialFormData);
    updateSaveButtonState();

    return isFormChanged;
}

function updateSaveButtonState() {
    const saveButton = document.querySelector('button[type="submit"]');

    if (saveButton) {
        if (isFormChanged) {
            saveButton.disabled = false;
            saveButton.style.opacity = '1';
            saveButton.style.cursor = 'pointer';
            saveButton.title = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
            saveButton.innerHTML = '<span>üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        } else {
            saveButton.disabled = true;
            saveButton.style.opacity = '0.6';
            saveButton.style.cursor = 'not-allowed';
            saveButton.title = '–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è';
            saveButton.innerHTML = '<span>üíæ</span> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';
        }
    }
}

function trackFormChanges() {
    const form = document.querySelector('form[method="POST"]');
    if (!form) return;

    const formElements = form.querySelectorAll('input, select, textarea');

    formElements.forEach(element => {
        if (element.type === 'hidden' || element.type === 'submit' || element.type === 'button') {
            return;
        }

        element.addEventListener('input', checkFormChanges);
        element.addEventListener('change', checkFormChanges);
        element.addEventListener('keyup', checkFormChanges);
    });

    initialFormData = getFormData();
    updateSaveButtonState();
}

// ========== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê (–í–ê–® –°–¢–ê–†–´–ô –ö–û–î) ==========

function viewPhoto(url) {
    window.open(url, '_blank');
}

function viewVideo(url) {
    window.open(url, '_blank');
}

function updateInterface() {
    const decision = document.querySelector('#id_decision').value;
    const conclusion = document.querySelector('#id_conclusion').value;
    const warrantySection = document.getElementById('warranty_repair_section');
    const paidRepairFields = document.getElementById('paid_repair_fields');

    if (paidRepairFields) {
        const showPaidFields = ['paid_repair', 'hydra_repair', 'demo_repair'].includes(decision);
        paidRepairFields.style.display = showPaidFields ? 'block' : 'none';
    }

    if (warrantySection) {
        const showWarrantySection = decision === 'warranty_repair' ||
                                   (conclusion === 'factory_defect' && decision === 'exchange') ||
                                   (decision === 'return') ||
                                   ['paid_repair', 'hydra_repair', 'demo_repair'].includes(decision);

        warrantySection.style.display = showWarrantySection ? 'block' : 'none';

        if (showWarrantySection) {
            updateWarrantyFields(decision, conclusion);
        }
    }
}

function updateWarrantyFields(decision, conclusion) {
    const isPaidRepair = ['paid_repair', 'hydra_repair', 'demo_repair'].includes(decision);

    const title = document.querySelector('#warranty_repair_section h3');
    if (title) {
        if (conclusion === 'factory_defect' && decision === 'exchange') {
            title.textContent = '–û–±–º–µ–Ω —Ç–æ–≤–∞—Ä–∞';
        } else if (decision === 'return') {
            title.textContent = '–í–æ–∑–≤—Ä–∞—Ç –∫–ª–∏–µ–Ω—Ç—É –±–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞';
        } else if (isPaidRepair) {
            if (decision === 'hydra_repair') {
                title.textContent = '–†–µ–º–æ–Ω—Ç –∑–∞ —Å—á–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ HYDRA';
            } else if (decision === 'demo_repair') {
                title.textContent = '–†–µ–º–æ–Ω—Ç –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É Demo car';
            } else {
                title.textContent = '–†–µ–º–æ–Ω—Ç –∑–∞ —Å—á–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞';
            }
        } else {
            title.textContent = '–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç';
        }
    }

    const paymentSection = document.getElementById('payment_section');
    if (paymentSection) {
        paymentSection.style.display = isPaidRepair ? 'block' : 'none';
    }

    document.getElementById('detected_problem_group').style.display = 'block';
    document.getElementById('additional_info_group').style.display = 'block';
    document.getElementById('internal_comment_group').style.display = 'block';

    if (conclusion === 'factory_defect' && decision === 'exchange') {
        hideRepairFields();
        document.getElementById('refusal_reason_group').style.display = 'none';
    } else if (decision === 'return') {
        document.getElementById('refusal_reason_group').style.display = 'block';
        hideRepairFields();
    } else {
        document.getElementById('refusal_reason_group').style.display = 'none';
        showRepairFields();
        toggleRepairSubtypes();
    }
}

function calculateTotalCost() {
    const laborCost = parseFloat(document.querySelector('#id_labor_cost')?.value) || 0;
    const partsCost = parseFloat(document.querySelector('#id_parts_cost')?.value) || 0;
    const discount = parseFloat(document.querySelector('#id_parts_discount')?.value) || 0;

    const discountedPartsCost = partsCost * (1 - discount / 100);
    const totalCost = laborCost + discountedPartsCost;

    const totalCostInput = document.querySelector('#id_total_cost');
    if (totalCostInput) {
        totalCostInput.value = totalCost.toFixed(2);
    }
}

function hideRepairFields() {
    document.getElementById('repair_details_group').style.display = 'none';
    document.getElementById('acoustics_repair_subtype').style.display = 'none';
    document.getElementById('amplifier_repair_subtype').style.display = 'none';
    document.getElementById('repair_performed_group').style.display = 'none';
}

function showRepairFields() {
    document.getElementById('repair_details_group').style.display = 'flex';
    document.getElementById('repair_performed_group').style.display = 'block';
}

function toggleRepairSubtypes() {
    const repairType = document.querySelector('#id_repair_type').value;
    const acousticsSubtype = document.getElementById('acoustics_repair_subtype');
    const amplifierSubtype = document.getElementById('amplifier_repair_subtype');

    acousticsSubtype.style.display = 'none';
    amplifierSubtype.style.display = 'none';

    if (repairType === 'acoustics') {
        acousticsSubtype.style.display = 'block';
    } else if (repairType === 'amplifier') {
        amplifierSubtype.style.display = 'block';
    }
}

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========

document.addEventListener('DOMContentLoaded', function() {
    // –ù–∞—Ö–æ–¥–∏–º —Ñ–æ—Ä–º—É
    const form = document.querySelector('form[method="POST"]');

    if (form) {
        originalForm = form;

        // –ù–∞—á–∏–Ω–∞–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
        trackFormChanges();

        // –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            if (!isFormChanged) {
                alert('–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                return;
            }

            if (isSubmitting) return;

            showConfirmationModal();
        });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('confirmSaveBtn')?.addEventListener('click', confirmSave);
    document.getElementById('cancelSaveBtn')?.addEventListener('click', cancelSave);

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.getElementById('confirmationModal')?.addEventListener('click', function(e) {
        if (e.target.id === 'confirmationModal') {
            cancelSave();
        }
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            cancelSave();
        }
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    const decisionSelect = document.querySelector('#id_decision');
    const conclusionSelect = document.querySelector('#id_conclusion');
    const repairTypeSelect = document.querySelector('#id_repair_type');

    if (decisionSelect) decisionSelect.addEventListener('change', updateInterface);
    if (conclusionSelect) conclusionSelect.addEventListener('change', updateInterface);
    if (repairTypeSelect) repairTypeSelect.addEventListener('change', toggleRepairSubtypes);

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    document.querySelector('#id_labor_cost')?.addEventListener('input', calculateTotalCost);
    document.querySelector('#id_parts_cost')?.addEventListener('input', calculateTotalCost);
    document.querySelector('#id_parts_discount')?.addEventListener('input', calculateTotalCost);

    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
    updateInterface();
    toggleRepairSubtypes();

    console.log('Script loaded - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–æ');
});
</script>

<style>
/* –î–æ–±–∞–≤—å—Ç–µ —Å—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ */
.modal {
    animation: fadeIn 0.3s ease;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.modal-content {
    animation: slideIn 0.3s ease;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ */
#confirmSaveBtn:hover {
    background: #45a049 !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: all 0.2s ease;
}

#cancelSaveBtn:hover {
    background: #e53935 !important;
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: all 0.2s ease;
}

/* –°—Ç–∏–ª–∏ –¥–ª—è disabled –∫–Ω–æ–ø–∫–∏ */
.action-btn.btn-primary:disabled {
    background-color: #cccccc !important;
    border-color: #cccccc !important;
    color: #666666 !important;
    cursor: not-allowed !important;
    opacity: 0.6 !important;
}

.action-btn.btn-primary:disabled:hover {
    background-color: #cccccc !important;
    border-color: #cccccc !important;
    transform: none !important;
    box-shadow: none !important;
}
</style>

{% endblock %}