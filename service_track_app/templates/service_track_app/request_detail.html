{% extends "service_track_app/base.html" %}
{% block title %}–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ #{{ repair_request.id }} (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ){% endblock %}

{% block content %}
<div class="request-detail-section">
    <div class="breadcrumb">
        {% for crumb in breadcrumbs %}
            <span class="{% if forloop.last %}breadcrumb-current{% else %}breadcrumb-item{% endif %}"
                  {% if not forloop.last %}onclick="window.location.href='{{ crumb.url }}'" style="cursor: pointer;"{% endif %}>
                {% if forloop.first %}üì¶{% endif %} {{ crumb.title }}
            </span>
            {% if not forloop.last %}
                <span class="breadcrumb-separator">‚Ä∫</span>
            {% endif %}
        {% endfor %}
    </div>
    <div class="request-details-actions">
        <button class="action-btn btn-secondary" type="button"
            onclick="window.location.href='{{ back_url }}'">
            ‚Üê –ö {{ back_title }}
        </button>
        <button class="action-btn btn-primary" type="submit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
    <form method="POST" action="{% url 'request_detail' repair_request.id %}">
        {% csrf_token %}
        <div class="request-detail-header">
            <div class="request-detail-title">–î–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏ #{{ repair_request.id }} (—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)</div>
        </div>
        <div class="request-details-form">
            <input type="hidden" name="request_id" value="{{ repair_request.id }}">
            <div class="details-row">
                <div class="details-group">
                    <label for="id_serial_number" class="details-label">–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–æ–≤–∞—Ä–∞</label>
                    {{ form.serial_number }}
                </div>
                <div class="details-group">
                    <label for="id_model_name" class="details-label">–¢–æ–≤–∞—Ä</label>
                    {{ form.product }}
                </div>
            </div>
            <div class="details-row">
                <div class="details-group">
                    <label for="id_purchase_date" class="details-label">–î–∞—Ç–∞ –ø–æ–∫—É–ø–∫–∏</label>
                    {{ form.purchase_date }}
                </div>
                <div class="details-group">
                    <label for="id_warranty_status" class="details-label">–°—Ç–∞—Ç—É—Å –≥–∞—Ä–∞–Ω—Ç–∏–∏</label>
                    {{ form.warranty_status }}
                </div>
            </div>
            <div class="details-row">
                <div class="details-group" style="grid-column: 1 / 2;">
                    <label for="id_problem_description" class="details-label">–û–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏</label>
                    {{ form.problem_description }}
                </div>
                <div class="details-group" style="grid-column: 2 / 3;">
                    <label for="id_problem_description" class="details-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏</label>
                    {{ form.additional_notes }}
                </div>
            </div>
            <div class="details-row">
                <div class="details-group" style="grid-column: 1 / -1;">
                    <label for="id_status" class="details-label">–°—Ç–∞—Ç—É—Å</label>
                    {{ form.status }}
                </div>
            </div>
            <div class="details-row">
                <div class="details-group" style="grid-column: 1 / 2;">
                    <div class="details-label">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏</div>
                    <div class="photo-gallery" id="detailsPhotoGallery">
                        {% if photos %}
                            {% for p in photos %}
                                <div class="photo-item" style="position: relative; display: inline-block; margin: 5px; width: 150px; height: 150px; overflow: hidden; border-radius: 10px;">
                                    <img src="{{ p.photo.url }}" alt="{{ p.photo.name }}"
                                         style="display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 10px; cursor: pointer;"
                                         onclick="viewPhoto('{{ p.photo.url }}')">
                                    <button class="photo-overlay"
                                            onclick="removePhoto({{ p.id }})"
                                            title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ"
                                            style="position:absolute; top:5px; right:5px; background:#0008; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer;">
                                        √ó
                                    </button>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div style="color: #666; font-style: italic; padding: 20px; text-align: center;">
                                –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="details-group" style="grid-column: 2 / 3;">
                    <div class="details-label">–í–∏–¥–µ–æ</div>
                    <div class="video-gallery" id="detailsVideoGallery">
                        {% if videos %}
                            {% for v in videos %}
                                <div class="video-item" style="position: relative; display: inline-block; margin: 5px; width: 320px; height: 240px; overflow: hidden; border-radius: 10px;">
                                    <video controls style="display: block; width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
                                        <source src="{{ v.video.url }}" type="video/mp4">
                                        –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                                    </video>
                                    <button class="video-overlay"
                                            onclick="removeVideo({{ v.id }})"
                                            title="–£–¥–∞–ª–∏—Ç—å –≤–∏–¥–µ–æ"
                                            style="position:absolute; top:5px; right:5px; background:#0008; color:white; border:none; border-radius:50%; width:25px; height:25px; cursor:pointer;">
                                        √ó
                                    </button>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div style="color: #666; font-style: italic; padding: 20px; text-align: center;">
                                –í–∏–¥–µ–æ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
<!-- –ë–ª–æ–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
<div class="details-group" style="grid-column: 1 / -1; background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
    <h3 style="margin: 0 0 20px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h3>

    <div class="details-row">
        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
            <label class="details-label">–î–∞—Ç–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</label>
            <input type="date" name="diagnosis_date" class="details-input">
        </div>
        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
            <label class="details-label">–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è</label>
            <input type="date" name="completion_date" class="details-input">
        </div>
    </div>

    <div class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
        <label class="details-label">–°–æ—Ç—Ä—É–¥–Ω–∏–∫ —Å–µ—Ä–≤–∏—Å–∞</label>
        <input type="text" name="service_employee" class="details-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞">
    </div>

    <div class="details-row">
        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
            <label class="details-label">–ó–∞–∫–ª—é—á–µ–Ω–∏–µ</label>
            <select name="conclusion" class="details-input">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–ª—é—á–µ–Ω–∏–µ</option>
                <option value="factory_defect">–ó–∞–≤–æ–¥—Å–∫–æ–π –±—Ä–∞–∫</option>
                <option value="no_issue">–ù–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å –Ω–µ –≤—ã—è–≤–ª–µ–Ω–∞</option>
                <option value="client_damage">–ò—Å–ø–æ—Ä—á–µ–Ω –∫–ª–∏–µ–Ω—Ç–æ–º</option>
                <option value="warranty_expired">–ò—Å—Ç–µ—á–µ–Ω–∏–µ —Å—Ä–æ–∫–∞ –≥–∞—Ä–∞–Ω—Ç–∏–∏</option>
            </select>
        </div>
        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
            <label class="details-label">–ü—Ä–∏–Ω—è—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ</label>
            <select name="decision" class="details-input">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ—à–µ–Ω–∏–µ</option>
                <option value="warranty_repair">–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</option>
                <option value="exchange">–û–±–º–µ–Ω –Ω–∞ –Ω–æ–≤—ã–π</option>
                <option value="return">–í–æ–∑–≤—Ä–∞—Ç –∫–ª–∏–µ–Ω—Ç—É –±–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞</option>
                <option value="paid_repair">–†–µ–º–æ–Ω—Ç –∑–∞ —Å—á–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞</option>
                <option value="hydra_repair">–†–µ–º–æ–Ω—Ç –∑–∞ —Å—á–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ HYDRA</option>
                <option value="demo_repair">–†–µ–º–æ–Ω—Ç –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É Demo car</option>
            </select>
        </div>
    </div>

    <div id="paid_repair_fields" style="display: none;">
        <div class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
            <label class="details-label">–§–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∞ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏</label>
            <textarea name="malfunction_formulation" class="details-textarea" rows="3" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞"></textarea>
        </div>
        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
            <label class="details-label">–¢–∏–ø —Ü–µ–Ω</label>
            <select name="price_type" class="details-input">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø —Ü–µ–Ω</option>
                <option value="retail">–†–æ–∑–Ω–∏—á–Ω–∞—è</option>
                <option value="dealer">–î–∏–ª–µ—Ä—Å–∫–∞—è</option>
            </select>
        </div>
    </div>

    <div class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
        <label class="details-label">–°—Ç–∞—Ç—É—Å –∞–∫—Ç–∞</label>
        <select name="act_status" class="details-input">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å</option>
            <option value="accepted">–¢–æ–≤–∞—Ä –ø—Ä–∏–Ω—è—Ç –¥–∏–ª–ª–µ—Ä–æ–º</option>
            <option value="waiting">–û–∂–∏–¥–∞–µ—Ç</option>
            <option value="sent">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –°–¶</option>
            <option value="closed">–ó–∞–∫—Ä—ã—Ç–∞</option>
            <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–∞</option>
        </select>
    </div>
</div>

            <!-- –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç -->
<div id="warranty_repair_section" class="details-group" style="grid-column: 1 / -1; background: white; padding: 20px; border-radius: 8px; margin: 20px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: none;">
    <h3 style="margin: 0 0 20px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 10px;">–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</h3>

    <div id="refusal_reason_group" class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1; display: none;">
        <label class="details-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–∞–∑–∞ –æ—Ç —Ä–µ–º–æ–Ω—Ç–∞</label>
        <select name="refusal_reason" class="details-input">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É</option>
            <option value="client_refused">–û—Ç –ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞ –æ—Ç–∫–∞–∑–∞–ª—Å—è</option>
            <option value="no_spare_parts">–ü–ª–∞—Ç–Ω—ã–π —Ä–µ–º–æ–Ω—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –≤ —Å–≤—è–∑–∏ —Å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º –∑–∞–ø–∞—Å–Ω—ã—Ö —á–∞—Å—Ç–µ–π</option>
        </select>
    </div>

    <div id="detected_problem_group" class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
        <label class="details-label">–í—ã—è–≤–ª–µ–Ω–Ω–∞—è –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å</label>
        <textarea name="detected_problem" class="details-textarea" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –≤—ã—è–≤–ª–µ–Ω–Ω—É—é –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å"></textarea>
    </div>

    <div id="repair_details_group" class="details-row">
        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
            <label class="details-label">–î–∞—Ç–∞ —Ä–µ–º–æ–Ω—Ç–∞</label>
            <input type="date" name="repair_date" class="details-input">
        </div>
        <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
            <label class="details-label">–í–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞</label>
            <select name="repair_type" id="repair_type" class="details-input">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≤–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞</option>
                <option value="acoustics">–ê–∫—É—Å—Ç–∏–∫–∞</option>
                <option value="amplifier">–£—Å–∏–ª–∏—Ç–µ–ª—å</option>
            </select>
        </div>
        <div id="acoustics_repair_subtype" style="display: none;">
            <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                <label class="details-label">–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞ –∞–∫—É—Å—Ç–∏–∫–∏</label>
                <input list="acoustics_options" name="acoustics_repair_subtype" class="details-input"
                       placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å —Ç–∏–ø —Ä–µ–º–æ–Ω—Ç–∞...">
                <datalist id="acoustics_options">
                    <option value="–ó–∞–º–µ–Ω–∞ –í–ß –¥–∏–Ω–∞–º–∏–∫–∞">
                    <option value="–ó–∞–º–µ–Ω–∞ –¥–∏–Ω–∞–º–∏–∫–∞">
                    <option value="–ó–∞–º–µ–Ω–∞ –¥–∏–Ω–∞–º–∏–∫–æ–≤">
                    <option value="–ó–∞–º–µ–Ω–∞ –∑–≤—É–∫–æ–≤–æ–π –∫–∞—Ç—É—à–∫–∏">
                    <option value="–ó–∞–º–µ–Ω–∞ –∫–æ—Ä–∑–∏–Ω—ã">
                    <option value="–ó–∞–º–µ–Ω–∞ –∫–æ—Ä–∑–∏–Ω—ã –∏ –ø–æ–¥–≤–∏–∂–Ω–æ–π —á–∞—Å—Ç–∏ –¥–∏–Ω–∞–º–∏–∫–∞">
                    <option value="–ó–∞–º–µ–Ω–∞ –ø–æ–¥–≤–∏–∂–Ω–æ–π —á–∞—Å—Ç–∏ –¥–∏–Ω–∞–º–∏–∫–∞">
                    <option value="–ó–∞–º–µ–Ω–∞ –ø–æ–¥–≤–∏–∂–Ω—ã—Ö —á–∞—Å—Ç–µ–π –¥–∏–Ω–∞–º–∏–∫–æ–≤">
                    <option value="–ó–∞–º–µ–Ω–∞ –ø—ã–ª–µ–∑–∞—â–∏—Ç–Ω–æ–≥–æ –∫–æ–ª–ø–∞–∫–∞">
                    <option value="–ó–∞–º–µ–Ω–∞ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞">
                    <option value="–ü—Ä–æ–∫–ª–µ–∏–≤–∞–Ω–∏–µ">
                    <option value="–ü—Ä–æ–∫–ª–µ–∏–≤–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ —Ü–µ–Ω—Ç—Ä–∏—Ä—É—é—â–∏—Ö —à–∞–π–±">
                    <option value="–ü—Ä–æ–∫–ª–µ–∏–≤–∞–Ω–∏–µ –ø–æ–¥–≤–µ—Å–∞">
                    <option value="–ü—Ä–æ–∫–ª–µ–∏–≤–∞–Ω–∏–µ –ø—ã–ª–µ–∑–∞—â–∏—Ç–Ω–æ–≥–æ –∫–æ–ª–ø–∞–∫–∞">
                    <option value="–ü—Ä–æ–ø–∞–π–∫–∞ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤">
                    <option value="–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –¥–µ—Ñ–µ–∫—Ç–∞ –±–µ–∑ –∑–∞–º–µ–Ω—ã –ø–æ–¥–≤–∏–∂–Ω–æ–π —á–∞—Å—Ç–∏">
                    <option value="–£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—Ä—ã–≤–∞ –∑–≤—É–∫–æ–≤–æ–π –∫–∞—Ç—É—à–∫–∏">
                    <option value="–¶–µ–Ω—Ç—Ä–æ–≤–∫–∞ –ø–æ–¥–≤–∏–∂–Ω–æ–π —á–∞—Å—Ç–∏">
                    <option value="–ß–∏—Å—Ç–∫–∞ –∑–∞–∑–æ—Ä–∞ –º–∞–≥–Ω–∏—Ç–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã –¥–∏–Ω–∞–º–∏–∫–∞">
                </datalist>
            </div>
        </div>
        <div id="amplifier_repair_subtype" style="display: none;">
            <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                <label class="details-label">–¢–∏–ø —Ä–µ–º–æ–Ω—Ç–∞ —É—Å–∏–ª–∏—Ç–µ–ª—è</label>
                <input list="amplifier_options" name="amplifier_repair_subtype" class="details-input"
                       placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å —Ç–∏–ø —Ä–µ–º–æ–Ω—Ç–∞...">
                <datalist id="amplifier_options">
                    <option value="–ó–∞–º–µ–Ω–∞ –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞">
                    <option value="–ó–∞–º–µ–Ω–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª–µ–π">
                    <option value="–ó–∞–º–µ–Ω–∞ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞ –≥—Ä–æ–º–∫–æ—Å—Ç–∏">
                    <option value="–ó–∞–º–µ–Ω–∞ —Ç–æ–ª–∫–∞—Ç–µ–ª—è –∫–Ω–æ–ø–∫–∏">
                    <option value="–ó–∞–º–µ–Ω–∞ —Ç—é–ª—å–ø–∞–Ω–æ–≤ –ì–°–ê">
                    <option value="–ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–π —Ä–µ–º–æ–Ω—Ç">
                    <option value="–ü–∏—Ç–∞–Ω–∏–µ –û–£">
                    <option value="–ü—Ä–æ–ø–∞–π–∫–∞ –ì–°–ê">
                    <option value="–†–µ–º–æ–Ω—Ç –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∫–∞—Å–∫–∞–¥–∞">
                    <option value="–†–µ–º–æ–Ω—Ç –ë–ü">
                    <option value="–†–µ–º–æ–Ω—Ç –ë–ü –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∫–∞—Å–∫–∞–¥–∞">
                    <option value="–†–µ–º–æ–Ω—Ç –û–£">
                    <option value="–†–µ–º–æ–Ω—Ç –ü–£">
                    <option value="–§–∏–ª—å—Ç—Ä –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∫–∞—Å–∫–∞–¥–∞">
                    <option value="–§–∏–ª—å—Ç—Ä –ø–∏—Ç–∞–Ω–∏—è –≤–µ–Ω—Ç–∏–ª—è—Ç–æ—Ä–∞">
                </datalist>
            </div>
        </div>
    </div>

    <div id="repair_performed_group" class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
        <label class="details-label">–ü—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–Ω—ã–π —Ä–µ–º–æ–Ω—Ç</label>
        <textarea name="repair_performed" class="details-textarea" rows="3" placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–Ω—ã–µ —Ä–∞–±–æ—Ç—ã"></textarea>
    </div>

    <div id="additional_info_group" class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
        <label class="details-label">–î–æ–ø –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</label>
        <textarea name="additional_info" class="details-textarea" rows="2" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è"></textarea>
    </div>

    <div id="internal_comment_group" class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
        <label class="details-label">–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
        <textarea name="internal_comment" class="details-textarea" rows="2" placeholder="–í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –¥–ª—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤"></textarea>
    </div>

    <div id="payment_section" style="display: none;">
        <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É -->
        <div class="details-group" style="background: none; padding: 0; box-shadow: none; grid-column: 1 / -1;">
            <label class="details-label">–°—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É</label>
            <input type="url" name="payment_link" class="details-input" placeholder="https://...">
        </div>

        <!-- –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ -->
        <div class="details-row">
            <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                <label class="details-label">–°—Ç–æ–∏–º–æ—Å—Ç—å —Ä–∞–±–æ—Ç</label>
                <input type="number" name="labor_cost" class="details-input" placeholder="0.00" step="0.01">
            </div>
            <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                <label class="details-label">–ó–∞–ø—á–∞—Å—Ç–∏</label>
                <input type="number" name="parts_cost" class="details-input" placeholder="0.00" step="0.01">
            </div>
            <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                <label class="details-label">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</label>
                <input type="number" name="total_cost" class="details-input" placeholder="0.00" step="0.01" readonly>
            </div>
            <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                <label class="details-label">% —Å–∫–∏–¥–∫–∏ –Ω–∞ –∑–∞–ø—á–∞—Å—Ç–∏</label>
                <input type="number" name="parts_discount" class="details-input" placeholder="0" min="0" max="100">
            </div>
            <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                <label class="details-label">–û–ø–ª–∞—á–µ–Ω–æ –∫–ª–∏–µ–Ω—Ç–æ–º</label>
                <input type="number" name="paid_by_client" class="details-input" placeholder="0.00" step="0.01">
            </div>
            <div class="details-group" style="background: none; padding: 0; box-shadow: none;">
                <label class="details-label">–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</label>
                <input type="date" name="payment_date" class="details-input">
            </div>
        </div>
    </div>
</div>

        </div>
    </form>
</div>

<script>
function viewPhoto(url) {
    window.open(url, '_blank');
}

function viewVideo(url) {
    window.open(url, '_blank');
}

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
function updateInterface() {
    const decision = document.querySelector('select[name="decision"]').value;
    const conclusion = document.querySelector('select[name="conclusion"]').value;
    const warrantySection = document.getElementById('warranty_repair_section');
    const paidRepairFields = document.getElementById('paid_repair_fields');

    // 1. –£–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—è–º–∏ –ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞ –≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ
    if (paidRepairFields) {
        const showPaidFields = ['paid_repair', 'hydra_repair', 'demo_repair'].includes(decision);
        paidRepairFields.style.display = showPaidFields ? 'block' : 'none';
    }

    // 2. –£–ø—Ä–∞–≤–ª—è–µ–º –±–ª–æ–∫–æ–º –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞ (—Ç–µ–ø–µ—Ä—å –∏ –¥–ª—è –ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞)
    if (warrantySection) {
        const showWarrantySection = decision === 'warranty_repair' ||
                                   (conclusion === 'factory_defect' && decision === 'exchange') ||
                                   (decision === 'return') ||
                                   ['paid_repair', 'hydra_repair', 'demo_repair'].includes(decision); // –î–û–ë–ê–í–ò–õ–ò –ü–õ–ê–¢–ù–´–ô –†–ï–ú–û–ù–¢

        warrantySection.style.display = showWarrantySection ? 'block' : 'none';

        if (showWarrantySection) {
            updateWarrantyFields(decision, conclusion);
        }
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—è–º–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ –≥–∞—Ä–∞–Ω—Ç–∏–π–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞
function updateWarrantyFields(decision, conclusion) {
    const isPaidRepair = ['paid_repair', 'hydra_repair', 'demo_repair'].includes(decision); // –î–û–ë–ê–í–ò–õ–ò

    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    const title = document.querySelector('#warranty_repair_section h3');
    if (title) {
        if (conclusion === 'factory_defect' && decision === 'exchange') {
            title.textContent = '–û–±–º–µ–Ω —Ç–æ–≤–∞—Ä–∞';
        } else if (decision === 'return') {
            title.textContent = '–í–æ–∑–≤—Ä–∞—Ç –∫–ª–∏–µ–Ω—Ç—É –±–µ–∑ —Ä–µ–º–æ–Ω—Ç–∞';
        } else if (isPaidRepair) { // –î–û–ë–ê–í–ò–õ–ò –î–õ–Ø –ü–õ–ê–¢–ù–û–ì–û –†–ï–ú–û–ù–¢–ê
            if (decision === 'hydra_repair') {
                title.textContent = '–†–µ–º–æ–Ω—Ç –∑–∞ —Å—á–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ HYDRA';
            } else if (decision === 'demo_repair') {
                title.textContent = '–†–µ–º–æ–Ω—Ç –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É Demo car';
            } else {
                title.textContent = '–†–µ–º–æ–Ω—Ç –∑–∞ —Å—á–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞';
            }
        } else {
            title.textContent = '–ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç';
        }
    }

    // –£–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—è–º–∏ –æ–ø–ª–∞—Ç—ã (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–ª–∞—Ç–Ω–æ–≥–æ —Ä–µ–º–æ–Ω—Ç–∞) - –î–û–ë–ê–í–ò–õ–ò
    const paymentSection = document.getElementById('payment_section');
    if (paymentSection) {
        paymentSection.style.display = isPaidRepair ? 'block' : 'none';
    }

    // –í—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —ç—Ç–∏ 3 –ø–æ–ª—è
    document.getElementById('detected_problem_group').style.display = 'block';
    document.getElementById('additional_info_group').style.display = 'block';
    document.getElementById('internal_comment_group').style.display = 'block';

    // –£–ø—Ä–∞–≤–ª—è–µ–º —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
    if (conclusion === 'factory_defect' && decision === 'exchange') {
        // –û–±–º–µ–Ω: —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è —Ä–µ–º–æ–Ω—Ç–∞
        hideRepairFields();
        document.getElementById('refusal_reason_group').style.display = 'none';
    } else if (decision === 'return') {
        // –í–æ–∑–≤—Ä–∞—Ç: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏—á–∏–Ω—É –æ—Ç–∫–∞–∑–∞, —Å–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª—è —Ä–µ–º–æ–Ω—Ç–∞
        document.getElementById('refusal_reason_group').style.display = 'block';
        hideRepairFields();
    } else {
        // –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–π —Ä–µ–º–æ–Ω—Ç –ò –ø–ª–∞—Ç–Ω—ã–π —Ä–µ–º–æ–Ω—Ç: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ –ø–æ–ª—è —Ä–µ–º–æ–Ω—Ç–∞
        document.getElementById('refusal_reason_group').style.display = 'none';
        showRepairFields();
        toggleRepairSubtypes();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ - –î–û–ë–ê–í–ò–õ–ò –ù–û–í–£–Æ –§–£–ù–ö–¶–ò–Æ
function calculateTotalCost() {
    const laborCost = parseFloat(document.querySelector('input[name="labor_cost"]')?.value) || 0;
    const partsCost = parseFloat(document.querySelector('input[name="parts_cost"]')?.value) || 0;
    const discount = parseFloat(document.querySelector('input[name="parts_discount"]')?.value) || 0;

    const discountedPartsCost = partsCost * (1 - discount / 100);
    const totalCost = laborCost + discountedPartsCost;

    const totalCostInput = document.querySelector('input[name="total_cost"]');
    if (totalCostInput) {
        totalCostInput.value = totalCost.toFixed(2);
    }
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function hideRepairFields() {
    document.getElementById('repair_details_group').style.display = 'none';
    document.getElementById('acoustics_repair_subtype').style.display = 'none';
    document.getElementById('amplifier_repair_subtype').style.display = 'none';
    document.getElementById('repair_performed_group').style.display = 'none';
}

function showRepairFields() {
    document.getElementById('repair_details_group').style.display = 'flex';
    document.getElementById('repair_performed_group').style.display = 'block';
}

function toggleRepairSubtypes() {
    const repairType = document.getElementById('repair_type').value;
    const acousticsSubtype = document.getElementById('acoustics_repair_subtype');
    const amplifierSubtype = document.getElementById('amplifier_repair_subtype');

    acousticsSubtype.style.display = 'none';
    amplifierSubtype.style.display = 'none';

    if (repairType === 'acoustics') {
        acousticsSubtype.style.display = 'block';
    } else if (repairType === 'amplifier') {
        amplifierSubtype.style.display = 'block';
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    const decisionSelect = document.querySelector('select[name="decision"]');
    const conclusionSelect = document.querySelector('select[name="conclusion"]');
    const repairTypeSelect = document.getElementById('repair_type');

    // –í–µ—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    if (decisionSelect) decisionSelect.addEventListener('change', updateInterface);
    if (conclusionSelect) conclusionSelect.addEventListener('change', updateInterface);
    if (repairTypeSelect) repairTypeSelect.addEventListener('change', toggleRepairSubtypes);

    // –î–û–ë–ê–í–ò–õ–ò –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    document.querySelector('input[name="labor_cost"]')?.addEventListener('input', calculateTotalCost);
    document.querySelector('input[name="parts_cost"]')?.addEventListener('input', calculateTotalCost);
    document.querySelector('input[name="parts_discount"]')?.addEventListener('input', calculateTotalCost);

    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
    updateInterface();
    toggleRepairSubtypes();
});

console.log('Script loaded');
</script>
{% endblock %}
