<!-- sc_package_detail.html -->
{% extends "service_track_app/base.html" %}
{% block title %}–ü–∞–∫–µ—Ç {{ p.id }}{% endblock %}

{% block content %}
<div id="receivedSection" class="section active">
<div class="received-requests-section">
    <div class="breadcrumb">
        <span class="breadcrumb-item" onclick="window.location.href='{% url 'sc_received_packages' %}'">üì¶ –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –ø–∞–∫–µ—Ç—ã</span>
        <span class="breadcrumb-separator">‚Ä∫</span>
        <span class="breadcrumb-current">–ü–∞–∫–µ—Ç –æ—Ç {{ p.created_at|date:"d.m.Y" }}</span>
    </div>
    <div id="packageDetailsContainer" class="package-details active">
        <button class="back-btn" onclick="window.location.href='{% url 'sc_received_packages' %}'">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É –ø–∞–∫–µ—Ç–æ–≤</button>
        <div class="requests-title" id="packageDetailsTitle">{{ p.dealer_company }} –æ—Ç {{ p.created_at|date:"d.m.Y" }}</div>

        <!-- –ë–ª–æ–∫ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π -->
        <div class="bulk-actions">
            <input type="checkbox" id="selectAllCheckbox" class="select-all-checkbox" title="–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ">
            <button id="markAsReceivedBtn" class="btn-primary" disabled>–û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞–∫ –ø—Ä–∏–Ω—è—Ç—ã–µ</button>
            <span id="selectedCount">–í—ã–±—Ä–∞–Ω–æ: 0</span>
        </div>

        <div id="packageRequestsContainer">
            <div class="package-requests-table-container">
                <table class="package-requests-table">
                    <thead>
                        <tr>
                            <th class="checkbox-header">–ü—Ä–∏–Ω—è—Ç–æ</th>
                            <th>‚Ññ –∑–∞—è–≤–∫–∏</th>
                            <th>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä</th>
                            <th>–ú–æ–¥–µ–ª—å</th>
                            <th>–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</th>
                            <th>–ü—Ä–æ–±–ª–µ–º–∞</th>
                            <th>–ì–∞—Ä–∞–Ω—Ç–∏—è</th>
                            <th>–í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in requests %}
                        <tr class="package-request-row {% if r.received_by_sc %}received-row{% endif %}"
                            data-request-id="{{ r.id }}">
                            <td data-label="–ü—Ä–∏–Ω—è—Ç–æ" class="checkbox-cell">
                                <input type="checkbox" class="received-checkbox"
                                       id="request-{{ r.id }}"
                                       data-request-id="{{ r.id }}"
                                       {% if r.received_by_sc %}checked disabled{% endif %}>
                            </td>
                            <td data-label="‚Ññ –∑–∞—è–≤–∫–∏" class="request-id">#{{ r.id }}</td>
                            <td data-label="–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä">{{ r.serial_number }}</td>
                            <td data-label="–ú–æ–¥–µ–ª—å">{{ r.model_name }}</td>
                            <td data-label="–ü–æ–∫—É–ø–∞—Ç–µ–ª—å">{{ r.customer_name }}</td>
                            <td data-label="–ü—Ä–æ–±–ª–µ–ºa" title="{{ r.problem_description }}">
                                {{ r.problem_description|truncatechars:50 }}
                            </td>
                            <td data-label="–ì–∞—Ä–∞–Ω—Ç–∏—è">
                                {% if r.status == "warranty" %}
                                    <span class="request-status status-sent">–ù–∞ –≥–∞—Ä–∞–Ω—Ç–∏–∏</span>
                                {% elif r.status == "expired" %}
                                    <span class="request-status status-created">–ì–∞—Ä–∞–Ω—Ç–∏—è –∏—Å—Ç–µ–∫–ª–∞</span>
                                {% else %}
                                    <span class="request-status status-created">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
                                {% endif %}
                            </td>
                            <td data-label="–í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è" class="request-date">{{ r.received_at|date:"H:i" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</div>

<script>
// JavaScript –∫–æ–¥ –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–æ—Ç –∂–µ
document.addEventListener('DOMContentLoaded', function() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const markAsReceivedBtn = document.getElementById('markAsReceivedBtn');
    const selectedCount = document.getElementById('selectedCount');
    const individualCheckboxes = document.querySelectorAll('.received-checkbox:not(:disabled)');

    function updateSelection() {
        const selectedCheckboxes = document.querySelectorAll('.received-checkbox:checked:not(:disabled)');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-request-id'));

        selectedCount.textContent = `–í—ã–±—Ä–∞–Ω–æ: ${selectedIds.length}`;
        markAsReceivedBtn.disabled = selectedIds.length === 0;

        const totalCheckboxes = document.querySelectorAll('.received-checkbox:not(:disabled)').length;
        const checkedCount = selectedCheckboxes.length;

        if (checkedCount === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedCount === totalCheckboxes) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    selectAllCheckbox.addEventListener('change', function() {
        const isChecked = this.checked;
        individualCheckboxes.forEach(checkbox => {
            if (checkbox.checked !== isChecked) {
                checkbox.checked = isChecked;
            }
        });
        updateSelection();
    });

    individualCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSelection);
    });

    markAsReceivedBtn.addEventListener('click', function() {
        const selectedCheckboxes = document.querySelectorAll('.received-checkbox:checked:not(:disabled)');
        const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-request-id'));

        if (selectedIds.length === 0) return;

        if (!confirm(`–û—Ç–º–µ—Ç–∏—Ç—å ${selectedIds.length} –∑–∞—è–≤–æ–∫ –∫–∞–∫ –ø—Ä–∏–Ω—è—Ç—ã–µ?`)) {
            return;
        }

        fetch('{% url "mark_requests_as_received" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                request_ids: selectedIds
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                selectedCheckboxes.forEach(checkbox => {
                    checkbox.disabled = true;
                    checkbox.closest('tr').classList.add('received-row');
                });

                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
                updateSelection();

                alert(`–£—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ—á–µ–Ω–æ ${selectedIds.length} –∑–∞—è–≤–æ–∫`);
            } else {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–æ–∫');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–æ–∫');
        });
    });

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    updateSelection();
});
</script>

<style>
/* –°—Ç–∏–ª–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–µ –∂–µ */
.bulk-actions {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.select-all-checkbox {
    transform: scale(1.3);
    cursor: pointer;
}

#markAsReceivedBtn:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
}

#selectedCount {
    font-size: 14px;
    color: #495057;
    font-weight: 500;
}

.checkbox-header {
    text-align: center;
    width: 80px;
}

.checkbox-cell {
    text-align: center;
    vertical-align: middle;
}

.received-checkbox {
    transform: scale(1.3);
    cursor: pointer;
}

.received-row {
    background-color: #f8fff9 !important;
    border-left: 4px solid #28a745;
}

.received-row td {
    opacity: 0.8;
}

.package-request-row {
    cursor: pointer;
    transition: background-color 0.2s;
}

.package-request-row:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}